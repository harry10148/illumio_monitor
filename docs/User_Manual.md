# Illumio PCE Monitor - Comprehensive User Manual

> **[English](User_Manual.md)** | **[繁體中文](User_Manual_zh.md)**

This manual provides a complete usage guide, operational overview, and configuration examples for the **Illumio PCE Monitor**. It is an advanced, Agentless monitoring tool designed specifically for Illumio Core (PCE), providing automated security event detection and traffic alerting via REST API.

---

## 1. Architecture & Workflow

The monitoring engine utilizes a dual-track parallel querying architecture for "Events" and "Traffic", improving inspection efficiency and significantly minimizing API overhead on the PCE. By default, it automatically executes its checks in the background every **10 minutes**.

### 1.1 Security Events Monitoring
Targeted towards auditing and operational events generated by the Illumio PCE itself.
- **Zero Duplicate Alerts**: The system records the precise "last check" timestamp in the local `state.json` file. Each time the API is called, it strictly fetches events that occurred *after* this timestamp.
- **Support for Cumulative Counts**: You can configure rules to trigger an alert only if an event happens N times within a designated window (e.g., 5 login failures within 10 minutes) or trigger immediately upon detection.

### 1.2 Traffic & Bandwidth Monitoring
Targeted towards analyzing network connections (Traffic Flows) and data transfer volumes between Workloads.
- **One-Pass Architecture**: To aggressively reduce API spam on the PCE, the system locally scans all configured traffic rules and determines the "longest monitoring window" (e.g., if you have 5-minute and 30-minute rules, the system will only query the API once for the past 30 minutes of data).
- **High-Performance Local Filtering**: After pulling the historical flows in bulk, the `Analyzer` engine performs a single traversal of all the data purely in memory, executing cross-comparisons against all your configured constraints (Port, Protocol, Label, IP, etc.).
- **Hybrid Calculation Mode**: When processing bandwidth and volumes, the system prioritizes precise "Delta" intervals. However, for continuous, long-lived connections (where a precise delta might not be measurable yet), the system falls back to calculating the connection's "Lifetime volume" to prevent massive data exfiltrations from slipping through unnoticed.

---

## 2. Execution Modes

The system supports three distinct execution modes to cater to operational and background daemon needs.

| Mode | Command Example | Use Case |
|:---|:---|:---|
| **Interactive CLI** | `python illumio_monitor.py` | Initial setup, manual rule management, quick connectivity testing. |
| **Web GUI** | `python illumio_monitor.py --gui` | Provides a visual dashboard and an intuitive management experience (requires Flask). Opens at `http://127.0.0.1:5001`. |
| **Daemon (Background process)** | `python illumio_monitor.py --monitor` | Deployed on servers for 24/7 unmonitored execution. You can adjust the check interval via `--interval 5` (in minutes). |

---

## 3. CLI Interaction & Examples

Upon running `python illumio_monitor.py`, you will be greeted with the interactive main menu:

```text
=== Illumio PCE Monitor ===
API: https://pce.lab.local:8443 | Rules: 2
----------------------------------------
1. Add Event Rule (inc. PCE Health Check)
2. Add Traffic Rule
...
0. Exit
```

### Example: Adding a Security Event Alert
1. Select `1` (Add Event Rule).
2. The system prompts for the Event Type. Enter: `agent.tampering`.
3. Select the threshold type. Enter `1` for immediate alerting.
4. Select the Time Window. Enter `10` to scan the last 10 minutes.
5. Once completed, the system will fire an alert whenever a Workload's VEN triggers a tampering event.

### Example: Managing & Deleting Rules
1. Select `4` (Manage Rules). The system prints the active rule list and their array index.
2. Following the prompt, if you want to delete indices 0 and 2, input `d 0,2`.

---

## 4. Web GUI Overview

Upon running `python illumio_monitor.py --gui`, a browser window will open the management console.

**Pro-Tip**: Out of the box, the UI defaults to the **Light Theme** and **English** language. You can seamlessly switch the language to "Traditional Chinese" or toggle to "Dark Theme" on the **Settings** tab. The UI will instantly redraw your preferences without requiring a page reload.

- **Dashboard**: Review overall API connectivity, rule counts, and check routines. Features a [Run Monitor Once] button which manually forces a cycle bypass wait times.
- **Rules**: Tabular enumeration of all Event, Traffic, and Bandwidth-Volume rules.
  - Tick the checkboxes on the left and click the red delete button to bulk eradicate rules.
  - Click the **Purple Pencil Icon** on the far right to unfold an edit modal. It automatically populates all existing filters for rapid modifications.
- **Actions**: Instantly load pre-built protective configurations by hitting [Load Best Practices]. This provisions baseline agent offline checks, tampering alerts, and login-failure barriers.

---

## 5. Rule Types & Filter Deep Dive

The traffic filtering mechanism in this system maps cleanly 100% 1:1 against the native Illumio Traffic Analysis API.

### 5.1 Event Rules
Listens to native PCE events natively, such as `user.login_failed`.
- **Threshold mode**: Supports `immediate` (alerts upon occurrence) and `count` (alerts upon N occurrences cumulatively over time).

### 5.2 Traffic Rules
Detects connection anomalies or unpredicted policy hits.
- **Policy Decision (pd)**:
  - `Blocked (2)`: Traffic officially dropped by current policies.
  - `Potential (1)`: Traffic currently allowed, but *would become dropped* if the workloads transitioned from Build over to Enforced mode (highly useful for simulation & tuning).
  - `Allowed (0)`: Evaluated as explicitly permitted.
- **Filtering Conditions**:
  - **Port / Proto**: Filter by generic protocol traits, e.g., Port `443` or Proto `6` (TCP).
  - **Label**: Exact string match format matching the PCE key format, e.g., `role=Web`.
  - **IP / IP List**: Format as CIDR blocks (e.g., `10.0.0.0/8`) or resolve using an explicit Illumio IP List object name.
  - Full support for negative inversions **(Exclude)** across all traits.

### 5.3 Bandwidth & Volume Rules
Specialized filters dedicated to detecting and alerting during Data Exfiltration attacks.
- **Bandwidth**: Calculates transmission peaks, measuring in `Mbps`.
- **Volume**: Calculates total cumulative data transfer within the evaluation window, measuring in `MB`.

---

## 6. System Settings & Alert Channels

All persistent settings are secured in unencrypted plaintext via `config.json`. These are universally modifiable through CLI wizards, the Web GUI, or an external text editor. By design, it **will not** be committed via Git to safeguard credential safety.

The suite supports three dispatch channels. They operate asynchronously and trigger concurrently:
1. **Email SMTP**: Outbound integration supporting STARTTLS, explicit SSL/TLS authentication.
2. **LINE Messaging API**: Dispatch mobile-first alerts by supplying a LINE Channel Access Token + Target ID.
3. **Webhook Endpoints**: Broadly hook into external SOC platforms, custom backend processors, Slack, or Microsoft Teams (sends standardized JSON Payloads).

**Activation Check**: Always ensure your intended channels are activated either from the GUI tab or within the active array slice of your raw `config.json` (`alerts.active: ["mail", "webhook"]`).
