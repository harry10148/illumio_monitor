<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Illumio PCE Monitor</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:wght@600;700&family=Lato:wght@400;600;700&display=swap');

    :root {
      --bg: #0F172A;
      --bg2: #1E293B;
      --bg3: #334155;
      --fg: #F8FAFC;
      --dim: #94A3B8;
      --dim: #94A3B8;
      --accent: #F97316;
      --accent2: #FB923C;
      --success: #10B981;
      --warn: #EAB308;
      --danger: #EF4444;
      --border: #475569;
      --radius: 8px;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      --header-font: 'EB Garamond', serif;
      --body-font: 'Lato', system-ui, sans-serif;
      color-scheme: dark light;
    }

    [data-theme="light"] {
      --bg: #F8FAFC;
      --bg2: #FFFFFF;
      --bg3: #F1F5F9;
      --fg: #0F172A;
      --dim: #64748B;
      --dim: #64748B;
      --accent: #EA580C;
      --accent2: #F97316;
      --success: #059669;
      --warn: #D97706;
      --danger: #DC2626;
      --border: #E2E8F0;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--body-font);
      background: var(--bg);
      color: var(--fg);
      min-height: 100vh;
      font-size: 14px;
    }

    a {
      color: var(--accent2);
      text-decoration: none;
      transition: color 0.15s ease;
    }

    a:hover {
      color: var(--accent);
    }

    h1,
    h2,
    h3,
    h4,
    .title {
      font-family: var(--header-font);
    }

    /* Header */
    .header {
      background: var(--bg2);
      padding: 16px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      font-size: 1.6rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent2), var(--success));
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
    }

    .header .meta {
      color: var(--dim);
      font-size: .85rem;
      font-family: var(--body-font);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--bg2);
      padding: 10px 20px 0;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      border-radius: var(--radius) var(--radius) 0 0;
      color: var(--dim);
      font-weight: 600;
      font-size: .95rem;
      transition: background-color 0.2s ease, color 0.2s ease;
      border: 1px solid transparent;
      border-bottom: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab:hover {
      color: var(--fg);
      background: var(--bg3);
    }

    .tab.active {
      color: var(--accent2);
      background: var(--bg);
      border-color: var(--border);
    }

    .tab svg {
      width: 16px;
      height: 16px;
      opacity: 0.8;
    }

    /* Panel */
    .panel {
      display: none;
      padding: 24px;
      animation: fadeIn .25s ease-out;
    }

    .panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    /* Cards & Widgets */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--accent);
    }

    .card .label {
      color: var(--dim);
      font-size: .85rem;
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card .value {
      font-size: 2rem;
      font-family: var(--header-font);
      font-weight: 700;
      color: var(--accent2);
    }

    .card .value.ok {
      color: var(--success);
    }

    .card .value.err {
      color: var(--danger);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius);
      font-size: .9rem;
      font-family: var(--body-font);
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .btn svg {
      width: 16px;
      height: 16px;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
    }

    .btn-primary:hover {
      background: var(--accent2);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .btn-secondary {
      background: var(--bg3);
      color: var(--fg);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-success {
      background: var(--success);
      color: #fff;
    }

    .btn-success:hover {
      filter: brightness(1.1);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-danger:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    .btn-warn {
      background: var(--warn);
      color: #fff;
    }

    .btn-warn:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    .btn-sm {
      padding: 6px 14px;
      font-size: .85rem;
      border-radius: 6px;
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      color: var(--dim);
      font-size: .85rem;
      margin-bottom: 6px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--fg);
      padding: 10px 14px;
      border-radius: 6px;
      font-size: .95rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-group input:focus-visible,
    .form-group select:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 1px;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.1);
    }

    .form-group input:focus:not(:focus-visible),
    .form-group select:focus:not(:focus-visible) {
      outline: none;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    /* Fieldset */
    fieldset {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      background: var(--bg2);
    }

    legend {
      color: var(--accent2);
      font-weight: 700;
      font-size: .95rem;
      padding: 0 12px;
      font-family: var(--header-font);
      letter-spacing: 0.5px;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-top: 12px;
    }

    .rule-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    .rule-table th,
    .rule-table td {
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: .88rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .rule-table th {
      color: var(--dim);
      font-weight: 700;
      background: var(--bg3);
      position: relative;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
    }

    .rule-table tr:last-child td {
      border-bottom: none;
    }

    .rule-table tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    .resizer {
      position: absolute;
      top: 25%;
      right: 0;
      width: 4px;
      height: 50%;
      cursor: col-resize;
      user-select: none;
      z-index: 2;
      transition: background-color 0.2s ease, opacity 0.2s ease;
      background: var(--dim);
      border-radius: 2px;
      opacity: 0;
    }

    .rule-table th:hover .resizer,
    .resizer:active {
      opacity: 1;
      background: var(--accent);
      width: 4px;
    }

    /* Log */
    .log-box {
      background: #000;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      font-family: 'Cascadia Code', 'Fira Code', monospace;
      font-size: .85rem;
      color: #A3E635;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.6;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    /* Actions */
    .action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .action-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .action-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
      border-color: var(--accent);
    }

    .action-card h3 {
      font-size: 1.1rem;
      color: var(--accent2);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .action-card h3 svg {
      width: 18px;
      height: 18px;
    }

    .action-card p {
      font-size: .9rem;
      color: var(--dim);
      flex: 1;
      line-height: 1.5;
    }

    /* Cell Popover (for truncated text) */
    .cell-popover {
      position: absolute;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      z-index: 9999;
      min-width: 200px;
      max-width: 350px;
      font-family: var(--body-font);
      color: var(--fg);
      animation: fadeInModal 0.15s ease-out;
    }

    .cell-popover h4 {
      margin: 0 0 12px 0;
      color: var(--accent);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    .cell-popover ul {
      margin: 0;
      padding: 0;
      list-style-type: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cell-popover ul li {
      font-size: 0.9rem;
      position: relative;
      padding-left: 14px;
      color: var(--fg);
    }

    .cell-popover ul li::before {
      content: "‚Ä¢";
      position: absolute;
      left: 0;
      color: var(--dim);
    }

    /* Modal */
    .modal-bg {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, .8);
      backdrop-filter: blur(4px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-bg.show {
      display: flex;
      animation: fadeInModal 0.2s ease-out;
    }

    @keyframes fadeInModal {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 28px;
      width: 600px;
      max-width: 95vw;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      transform: scale(0.95);
      transition: transform 0.2s ease-out;
    }

    .modal-bg.show .modal {
      transform: scale(1);
    }

    .modal {
      overscroll-behavior: contain;
    }

    .modal h2 {
      font-size: 1.3rem;
      color: var(--accent2);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal h2 svg {
      width: 22px;
      height: 22px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    /* Toolbar */
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      align-items: center;
    }

    .toolbar .spacer {
      flex: 1;
    }

    .badge {
      background: var(--accent);
      color: #fff;
      padding: 2px 10px;
      border-radius: 20px;
      font-size: .8rem;
      font-weight: 700;
    }

    /* Radio group */
    .radio-group {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      padding: 4px 0;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--fg);
      font-size: .9rem;
      cursor: pointer;
    }

    .radio-group input[type=radio] {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Checkbox */
    .chk label {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--fg);
      font-size: .9rem;
      cursor: pointer;
    }

    .chk input[type=checkbox] {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--success);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      font-size: .9rem;
      z-index: 200;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
      box-shadow: var(--shadow);
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    .toast.err {
      background: var(--danger);
    }

    /* Quarantine Feature - SubNav & Floating Bar */
    .sub-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: var(--bg2);
      padding: 4px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      width: fit-content;
    }

    .sub-nav-btn {
      background: transparent;
      color: var(--dim);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .sub-nav-btn:hover {
      color: var(--fg);
    }

    .sub-nav-btn.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .sub-nav-btn svg {
      width: 16px;
      height: 16px;
    }

    .q-panel {
      display: none;
      animation: fadeIn 0.2s;
    }

    .q-panel.active {
      display: block;
    }

    .floating-action-bar {
      position: fixed;
      bottom: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      gap: 20px;
      z-index: 50;
      transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
      pointer-events: none;
    }

    .floating-action-bar.show {
      bottom: 32px;
      pointer-events: auto;
    }

    .floating-action-bar .sel-count {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent2);
      font-family: var(--header-font);
    }

    /* Labels Display */
    .lbl {
      background: var(--bg3);
      color: var(--fg);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      margin-right: 4px;
      display: inline-block;
      white-space: nowrap;
      margin-top: 4px;
      border: 1px solid var(--border);
      font-family: monospace;
    }

    .lbl-quarantine {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      font-weight: bold;
    }

    /* Skeletons */
    .skeleton {
      position: relative;
      overflow: hidden;
      background: var(--bg3);
      border-radius: 4px;
    }

    .skeleton::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
      animation: loading 1.5s infinite;
    }

    @keyframes loading {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    .skel-text {
      height: 14px;
      width: 60%;
      margin-bottom: 8px;
    }

    .skel-text.short {
      width: 30%;
    }

    .skel-tr td {
      padding: 16px;
    }

    /* SVG Icons Helper Classes */
    .icon {
      display: inline-block;
      vertical-align: middle;
      fill: currentColor;
    }

    /* Dropdown */
    .severity-select {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--fg);
      padding: 12px;
      border-radius: 8px;
      width: 100%;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .severity-select:focus-visible {
      border-color: var(--danger);
      outline: 2px solid var(--danger);
      outline-offset: 1px;
      box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1);
    }

    .severity-select:focus:not(:focus-visible) {
      outline: none;
    }

    .severity-select option[value="Mild"] {
      color: var(--accent2);
    }

    .severity-select option[value="Moderate"] {
      color: var(--warn);
    }

    .severity-select option[value="Severe"] {
      color: var(--danger);
      font-weight: bold;
    }
  </style>
</head>

<body>

  <!-- SVG Icons definition for reuse -->
  <svg style="display:none">
    <symbol id="icon-shield" viewBox="0 0 24 24">
      <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"
        d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
    </symbol>
    <symbol id="icon-activity" viewBox="0 0 24 24">
      <polyline stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"
        points="22 12 18 12 15 21 9 3 6 12 2 12" />
    </symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" fill="none" />
      <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"
        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
    </symbol>
    <symbol id="icon-play" viewBox="0 0 24 24">
      <polygon stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"
        points="5 3 19 12 5 21 5 3" />
    </symbol>
    <symbol id="icon-search" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round" />
    </symbol>
    <symbol id="icon-alert" viewBox="0 0 24 24">
      <path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"
        d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
      <line x1="12" y1="9" x2="12" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round" />
      <line x1="12" y1="17" x2="12.01" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round" />
    </symbol>
    <symbol id="icon-check" viewBox="0 0 24 24">
      <polyline stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"
        points="20 6 9 17 4 12" />
    </symbol>
    <symbol id="icon-cross" viewBox="0 0 24 24">
      <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round" />
      <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round" />
    </symbol>
    <symbol id="icon-stop" viewBox="0 0 24 24">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" fill="none" />
    </symbol>
  </svg>

  <div class="header">
    <h1 data-i18n="gui_title">
      <svg class="icon" style="width:24px;height:24px;margin-right:8px;color:var(--accent2);">
        <use href="#icon-shield"></use>
      </svg>
      Illumio PCE Monitor
    </h1>
    <div style="display:flex;align-items:center;gap:16px">
      <span class="meta" id="hdr-meta">Loading...</span>
      <button class="btn btn-secondary btn-sm" onclick="stopGui()" title="Stop Web GUI" data-i18n="gui_stop">
        <svg class="icon" aria-hidden="true" focusable="false">
          <use href="#icon-stop"></use>
        </svg> Stop
      </button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('dashboard')" data-i18n="gui_tab_dashboard">
      <svg class="icon">
        <use href="#icon-activity"></use>
      </svg> Traffic & Quarantine
    </div>
    <div class="tab" onclick="switchTab('rules')" data-i18n="gui_tab_rules">
      <svg class="icon">
        <use href="#icon-shield"></use>
      </svg> Rules
    </div>
    <div class="tab" onclick="switchTab('settings')" data-i18n="gui_tab_settings">
      <svg class="icon">
        <use href="#icon-settings"></use>
      </svg> Settings
    </div>
    <div class="tab" onclick="switchTab('actions')" data-i18n="gui_tab_actions">
      <svg class="icon">
        <use href="#icon-play"></use>
      </svg> Actions
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Traffic & Quarantine (Dashboard Tab) ‚ïê‚ïê‚ïê -->
  <div class="panel active" id="p-dashboard">

    <!-- Top level stats -->
    <div class="cards">
      <div class="card">
        <div class="label" data-i18n="gui_active_rules">Active Rules</div>
        <div class="value" id="d-rules">‚Äî</div>
      </div>
      <div class="card">
        <div class="label" data-i18n="gui_health_check">Health Check</div>
        <div class="value" id="d-health">‚Äî</div>
      </div>
      <div class="card">
        <div class="label" data-i18n="gui_language">Language</div>
        <div class="value" id="d-lang">‚Äî</div>
      </div>
    </div>

    <fieldset id="cd-field" style="display:none;margin-bottom:24px;border:none;padding:0;">
      <div id="cd-list" class="cards" style="margin-bottom:0;"></div>
    </fieldset>

    <!-- Sub Navigation for Traffic & Quarantine -->
    <div class="sub-nav">
      <button class="sub-nav-btn active" onclick="switchQTab('traffic')" id="qbtn-traffic">
        <svg class="icon">
          <use href="#icon-activity"></use>
        </svg> <span data-i18n="gui_traffic_analyzer">Traffic Analyzer</span>
      </button>
      <button class="sub-nav-btn" onclick="switchQTab('workloads')" id="qbtn-workloads">
        <svg class="icon">
          <use href="#icon-search"></use>
        </svg> <span data-i18n="gui_workload_search">Workload Search</span>
      </button>
      <button class="sub-nav-btn" onclick="switchQTab('legacy')" id="qbtn-legacy"
        style="margin-left:auto; opacity: 0.7;">
        <span data-i18n="gui_top10_widgets">Top 10 Widgets</span>
      </button>
    </div>

    <!-- Traffic Analyzer Panel -->
    <div id="q-panel-traffic" class="q-panel active">
      <fieldset>
        <legend data-i18n="gui_ta_query">Traffic Analysis Query</legend>
        <div class="toolbar">
          <div class="form-group" style="margin-bottom:0;">
            <label data-i18n="gui_window">Window</label>
            <select id="qt-mins" style="width:120px;">
              <option value="15" data-i18n="gui_win_15m">Last 15m</option>
              <option value="60" selected data-i18n="gui_win_1h">Last 1 hr</option>
              <option value="1440" data-i18n="gui_win_24h">Last 24 hr</option>
              <option value="10080" data-i18n="gui_win_1w">Last 1 Week</option>
              <option value="43200" data-i18n="gui_win_1m">Last 1 Month</option>
            </select>
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label data-i18n="gui_filter_details">Filter Details</label>
            <input id="qt-search" name="traffic-search" autocomplete="off" spellcheck="false"
              placeholder="Quick Search String‚Ä¶" style="width: 150px;" data-i18n="gui_quick_search_placeholder">
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label data-i18n="gui_sort_by">Sort By</label>
            <select id="qt-sort" style="width:140px;">
              <option value="bandwidth">Max Bandwidth</option>
              <option value="volume">Total Volume</option>
              <option value="connections">Connections</option>
            </select>
          </div>

          <div class="spacer"></div>
          <button class="btn btn-secondary" onclick="openQtFiltersModal()" style="height: 42px; align-self:flex-end;"
            title="Advanced Filters">
            <svg class="icon">
              <use href="#icon-settings"></use>
            </svg> <span data-i18n="gui_filter_settings">Filter Settings</span>
          </button>
          <button class="btn btn-secondary" onclick="openQtGuideModal()" style="height: 42px; align-self:flex-end;"
            title="Parameter Guide">
            <svg class="icon">
              <use href="#icon-help-circle"></use>
            </svg> <span data-i18n="gui_param_guide">Guide</span>
          </button>
          <button class="btn btn-primary" onclick="runTrafficAnalyzer()" style="height: 42px; align-self:flex-end;">
            <svg class="icon">
              <use href="#icon-search"></use>
            </svg> <span data-i18n="gui_query_flow">Query Flow</span>
          </button>
        </div>

        <div class="table-container">
          <table class="rule-table">
            <thead>
              <tr>
                <th style="width:30px;text-align:center;"><input type="checkbox" id="qt-chkall"
                    onchange="toggleQChecks('qt-chk')"></th>
                <th style="width:120px" data-i18n="gui_metric">Metric</th>
                <th style="width:110px" data-i18n="gui_first_last_seen">First/Last Seen</th>
                <th data-i18n="gui_source_identity">Source Identity</th>
                <th data-i18n="gui_destination_identity">Destination Identity</th>
                <th style="width:90px" data-i18n="gui_service_port">Service</th>
                <th style="width:80px" data-i18n="gui_policy_dec">Policy Decision</th>
                <th style="width:80px" data-i18n="gui_actions">Actions</th>
              </tr>
            </thead>
            <tbody id="qt-body">
              <tr>
                <td colspan="8" style="text-align:center;padding:40px;color:var(--dim);">Run a query to view real-time
                  traffic anomalies.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination-bar" id="qt-pagination"
          style="display:none; margin-top:12px; align-items:center; gap:12px;">
          <div style="font-size:12px; color:var(--dim);" id="qt-total-count"></div>
          <div style="flex:1"></div>
          <label style="font-size:12px;" data-i18n="gui_page_size">Page Size</label>
          <select id="qt-page-size" style="width:70px; padding:4px; font-size:12px; height:28px;"
            onchange="_qt_page=1; renderQtPage();">
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <button class="btn btn-sm btn-secondary" onclick="qtPrevPage()" data-i18n="gui_prev">Prev</button>
          <span id="qt-page-num" style="font-size:12px; font-weight:bold;">1</span>
          <button class="btn btn-sm btn-secondary" onclick="qtNextPage()" data-i18n="gui_next">Next</button>
        </div>
      </fieldset>
    </div>

    <!-- Workloads Search Panel -->
    <div id="q-panel-workloads" class="q-panel">
      <fieldset>
        <legend data-i18n="gui_ws_search">Advanced Workload Search</legend>
        <div class="toolbar">
          <div class="form-group" style="margin-bottom:0; flex:1;">
            <label data-i18n="gui_workload_name">Workload Name</label>
            <input id="qw-name" name="workload-name" autocomplete="workload-name" spellcheck="false"
              placeholder="Exact or partial name">
          </div>
          <div class="form-group" style="margin-bottom:0; flex:1;">
            <label data-i18n="gui_ip_address">IP Address</label>
            <input id="qw-ip" name="workload-ip" autocomplete="workload-ip" spellcheck="false"
              placeholder="e.g. 10.0.0.5">
          </div>
          <div class="form-group" style="margin-bottom:0; flex:1;">
            <label data-i18n="gui_hostname">Hostname</label>
            <input id="qw-host" name="workload-hostname" autocomplete="workload-hostname" spellcheck="false"
              placeholder="Hostname match">
          </div>
          <button class="btn btn-primary" onclick="runWorkloadSearch()" style="height: 42px; align-self:flex-end;">
            <svg class="icon">
              <use href="#icon-search"></use>
            </svg> <span data-i18n="gui_find">Find</span>
          </button>
        </div>

        <div class="table-container">
          <table class="rule-table">
            <thead>
              <tr>
                <th style="width:50px"><input type="checkbox" id="qw-chkall" onchange="toggleQChecks('qw-chk')"></th>
                <th style="width:180px" data-i18n="gui_ws_col_status">Status / Name</th>
                <th style="width:100px" data-i18n="gui_ws_col_management">Management</th>
                <th style="width:150px" data-i18n="gui_ws_col_ip">IP & Interface</th>
                <th data-i18n="gui_ws_col_labels">Active Labels</th>
                <th style="width:140px" data-i18n="gui_actions">Actions</th>
              </tr>
            </thead>
            <tbody id="qw-body">
              <tr>
                <td colspan="6" style="text-align:center;padding:40px;color:var(--dim);" data-i18n="gui_ws_empty">Search
                  by IP or Name to find
                  workloads in the PCE.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination-bar" id="qw-pagination"
          style="display:none; margin-top:12px; align-items:center; gap:12px;">
          <div style="font-size:12px; color:var(--dim);" id="qw-total-count"></div>
          <div class="spacer"></div>
          <label style="font-size:12px;" data-i18n="gui_page_size">Page Size</label>
          <select id="qw-page-size" style="width:70px; padding:4px; font-size:12px; height:28px;"
            onchange="_qw_page=1; renderQwPage();">
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
          <button class="btn btn-sm btn-secondary" onclick="qwPrevPage()" data-i18n="gui_prev">Prev</button>
          <span id="qw-page-num" style="font-size:12px; font-weight:bold;">1</span>
          <button class="btn btn-sm btn-secondary" onclick="qwNextPage()" data-i18n="gui_next">Next</button>
        </div>
      </fieldset>
    </div>

    <!-- Legacy Dashboards -->
    <div id="q-panel-legacy" class="q-panel">
      <fieldset style="margin-bottom:14px;">
        <legend><span data-i18n="gui_top10_title" style="font-size:1.05rem;">Top 10 Query Report</span></legend>
        <div style="display:flex;gap:12px;margin-bottom:16px;align-items:center;">
          <label data-i18n="gui_window_min"
            style="font-weight:700;color:var(--dim);font-size:0.85rem;text-transform:uppercase;">Window (min):</label>
          <input id="d-global-min" type="number" value="30"
            style="width:100px;background:var(--bg);border:1px solid var(--border);color:var(--fg);padding:8px 12px;border-radius:6px;">
          <span style="flex:1"></span>
          <button class="btn btn-secondary btn-sm" onclick="openQueryModal()" data-i18n="gui_add_query_widget">‚ûï Add
            Query Widget</button>
          <button class="btn btn-primary btn-sm" onclick="runAllQueries()" data-i18n="gui_run_all_queries"><svg
              class="icon">
              <use href="#icon-play"></use>
            </svg> Run All</button>
        </div>
        <div id="d-queries-container" style="display:flex;flex-direction:column;gap:20px;">
          <!-- Query Profile Tables generated dynamically -->
        </div>
      </fieldset>
    </div>

  </div>

  <!-- Floating Bulk Quarantine Action Bar -->
  <div class="floating-action-bar" id="bulk-bar">
    <div style="color:var(--fg); font-size:1rem;">
      Selected <span class="sel-count" id="bulk-sel-count">0</span> workloads
    </div>
    <button class="btn btn-danger" onclick="openQuarantineModal(null, true)">
      <svg class="icon">
        <use href="#icon-alert"></use>
      </svg> Apply Quarantine
    </button>
  </div>

  <!-- ‚ïê‚ïê‚ïê Rules ‚ïê‚ïê‚ïê -->
  <div class="panel" id="p-rules">
    <div class="toolbar">
      <span style="font-size:1.1rem;font-weight:700;color:var(--accent2)" data-i18n="gui_tab_rules">Rules</span>
      <span class="badge" id="r-badge">0</span>
      <button class="btn btn-sm" style="margin-left:8px;background:var(--dim);color:#fff" onclick="openModal('m-help')"
        data-i18n="gui_param_guide">üìñ Parameter Guide</button>
      <div class="spacer"></div>
      <button class="btn btn-warn btn-sm" onclick="openModal('m-event')" data-i18n="gui_add_event">üìã + Event</button>
      <button class="btn btn-warn btn-sm" onclick="openModal('m-traffic')" data-i18n="gui_add_traffic">üö¶ +
        Traffic</button>
      <button class="btn btn-warn btn-sm" onclick="openModal('m-bw')" data-i18n="gui_add_bw">üìä + BW/Vol</button>
      <button class="btn btn-danger btn-sm" onclick="deleteSelected()" data-i18n="gui_delete">üóë Delete</button>
    </div>
    <table class="rule-table">
      <thead>
        <tr>
          <th style="width:30px"><input type="checkbox" id="r-chkall" onchange="toggleAll(this)"></th>
          <th data-i18n="gui_col_type">Type</th>
          <th data-i18n="gui_col_name">Name</th>
          <th style="width:110px" data-i18n="gui_col_status">Status</th>
          <th data-i18n="gui_col_condition">Condition</th>
          <th data-i18n="gui_col_filters">Filters</th>
          <th style="width:50px" data-i18n="gui_col_edit">Edit</th>
        </tr>
      </thead>
      <tbody id="r-body"></tbody>
    </table>
  </div>

  <!-- ‚ïê‚ïê‚ïê Settings ‚ïê‚ïê‚ïê -->
  <div class="panel" id="p-settings">
    <div class="cards" style="margin-bottom:14px;">
      <div class="card">
        <div class="label" data-i18n="gui_api_status">API Status</div>
        <div class="value" id="d-api">‚Äî</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button class="btn btn-primary" onclick="testConn()" data-i18n="gui_test_conn">üîó Test Connection</button>
    </div>
    <div class="log-box" id="s-log" style="height:80px;margin-bottom:14px;font-size:0.85rem;">[Ready]</div>
    <div id="s-form"></div>
    <div style="text-align:right;margin-top:16px;">
      <button class="btn btn-success" onclick="saveSettings()" data-i18n="gui_save_all">üíæ Save All Settings</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Actions ‚ïê‚ïê‚ïê -->
  <div class="panel" id="p-actions">
    <div class="action-grid">
      <div class="action-card">
        <h3 data-i18n="gui_run_once">‚ñ∂ Run Monitor Once</h3>
        <p data-i18n="gui_run_once_desc">Execute full cycle: Health ‚Üí Fetch ‚Üí Analyze ‚Üí Alert</p><button
          class="btn btn-primary" onclick="runAction('run')" data-i18n="gui_run_btn">Run</button>
      </div>
      <div class="action-card">
        <h3 data-i18n="gui_debug_mode">üîç Debug Mode</h3>
        <p data-i18n="gui_debug_desc">Sandbox mode ‚Äî no alerts, no state updates</p>
        <div class="form-row" style="margin-bottom:8px;">
          <div class="form-group"><label data-i18n="gui_window_min">Window (min)</label><input id="a-debug-mins"
              value="30"></div>
          <div class="form-group"><label data-i18n="gui_policy_dec">Policy Dec.</label><select id="a-debug-pd">
              <option value="1" data-i18n="gui_pd_blocked">Blocked</option>
              <option value="2" data-i18n="gui_pd_allowed">Allowed</option>
              <option value="3" data-i18n="gui_pd_all" selected>All</option>
            </select></div>
        </div>
        <button class="btn btn-primary" onclick="runDebug()" data-i18n="gui_run_debug">Run Debug</button>
      </div>
      <div class="action-card">
        <h3 data-i18n="gui_test_alert">üìß Send Test Alert</h3>
        <p data-i18n="gui_test_alert_desc">Verify Email / LINE / Webhook delivery</p><button class="btn btn-primary"
          onclick="runAction('test-alert')" data-i18n="gui_send">Send</button>
      </div>
      <div class="action-card">
        <h3 data-i18n="gui_best_practices">üìã Load Best Practices</h3>
        <p data-i18n="gui_best_practices_desc">Replace ALL existing rules with recommended defaults</p><button
          class="btn btn-danger" onclick="confirmBestPractices()" data-i18n="gui_load">Load</button>
      </div>
    </div>
    <h3 style="color:var(--accent2);margin-bottom:8px;" data-i18n="gui_output">Output</h3>
    <div class="log-box" id="a-log"></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Modals ‚ïê‚ïê‚ïê -->
  <!-- Dashboard Query Profile Modal -->
  <div class="modal-bg" id="m-query">
    <div class="modal">
      <h2><span data-i18n="gui_add_query_widget" id="mq-title">Add Query Widget</span></h2>
      <input type="hidden" id="dq-idx" value="-1">
      <div class="form-row">
        <div class="form-group"><label data-i18n="gui_query_widget_name">Widget Name</label><input id="dq-name"
            placeholder="E.g. Core Services Top Clients"></div>
        <div class="form-group"><label data-i18n="gui_rank_by">Rank By</label><select id="dq-rank">
            <option value="count" data-i18n="gui_rank_count">Connection Count</option>
            <option value="volume" data-i18n="gui_rank_volume">Total Volume (MB)</option>
            <option value="bandwidth" data-i18n="gui_rank_bw">Max Bandwidth (Mbps)</option>
          </select></div>
      </div>
      <fieldset>
        <legend data-i18n="gui_policy_dec">Policy Decision</legend>
        <div class="radio-group" id="dq-pd-group">
          <label><input type="radio" name="dq-pd" value="3" checked> <span data-i18n="gui_pd_all">All</span></label>
          <label><input type="radio" name="dq-pd" value="2"> <span data-i18n="gui_pd_blocked">Blocked</span></label>
          <label><input type="radio" name="dq-pd" value="1"> <span data-i18n="gui_pd_potential">Potential</span></label>
          <label><input type="radio" name="dq-pd" value="0"> <span data-i18n="gui_pd_allowed">Allowed</span></label>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_col_filters">Filters</legend>
        <div class="form-row">
          <div class="form-group"><label data-i18n="gui_port">Port</label><input id="dq-port"
              placeholder="e.g. 80, 443"></div>
          <div class="form-group"><label data-i18n="gui_protocol">Protocol</label><select id="dq-proto">
              <option value="" data-i18n="gui_both">Both</option>
              <option value="6" data-i18n="gui_tcp">TCP</option>
              <option value="17" data-i18n="gui_udp">UDP</option>
            </select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label data-i18n="gui_source">Source (Label/IP)</label><input id="dq-src"
              placeholder="e.g. role=Web, 10.0.0.0/8, 192.168.1.1"></div>
          <div class="form-group"><label data-i18n="gui_dest">Destination (Label/IP)</label><input id="dq-dst"
              placeholder="e.g. app=DB, 10.1.1.5"></div>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_excludes">Excludes (Optional)</legend>
        <div class="form-row-3">
          <div class="form-group"><label data-i18n="gui_ex_port">Exclude Port</label><input id="dq-expt"
              placeholder="e.g. 22"></div>
          <div class="form-group"><label data-i18n="gui_ex_src">Exclude Source</label><input id="dq-exsrc"
              placeholder="e.g. env=Kube, 10.9.9.9"></div>
          <div class="form-group"><label data-i18n="gui_ex_dest">Exclude Destination</label><input id="dq-exdst"
              placeholder="e.g. 8.8.8.8"></div>
        </div>
      </fieldset>
      <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-query')"
          data-i18n="gui_cancel">Cancel</button><button class="btn btn-success" onclick="saveDashboardQuery()"
          data-i18n="gui_save">üíæ Save</button></div>
    </div>
  </div>

  <!-- Traffic Analyzer Advanced Filters Modal -->
  <div class="modal-bg" id="modal-qt-filters">
    <div class="modal">
      <h2><svg class="icon">
          <use href="#icon-settings"></use>
        </svg> Traffic Analyzer Filters</h2>
      <fieldset>
        <legend data-i18n="gui_col_filters">Filters</legend>
        <div class="form-row">
          <div class="form-group"><label data-i18n="gui_port">Port</label><input id="qt-port"
              placeholder="e.g. 80, 443"></div>
          <div class="form-group"><label data-i18n="gui_protocol">Protocol</label><select id="qt-proto">
              <option value="" data-i18n="gui_both">Both</option>
              <option value="6" data-i18n="gui_tcp">TCP</option>
              <option value="17" data-i18n="gui_udp">UDP</option>
            </select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label data-i18n="gui_source">Source (Label/IP)</label><input id="qt-src"
              placeholder="e.g. role=Web, 10.0.0.0/8"></div>
          <div class="form-group"><label data-i18n="gui_dest">Destination (Label/IP)</label><input id="qt-dst"
              placeholder="e.g. app=DB, 10.1.1.5"></div>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_policy_dec">Policy Decision</legend>
        <div class="radio-group" style="margin-top: 5px; margin-bottom: 5px;">
          <label><input type="radio" name="qt-pd-radio" value="2" checked> <span
              data-i18n="gui_pd_blocked">Blocked</span></label>
          <label><input type="radio" name="qt-pd-radio" value="1"> <span
              data-i18n="gui_pd_potential">Potential</span></label>
          <label><input type="radio" name="qt-pd-radio" value="0"> <span
              data-i18n="gui_pd_allowed">Allowed</span></label>
          <label><input type="radio" name="qt-pd-radio" value="-1"> <span data-i18n="gui_pd_all">All</span></label>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_excludes">Excludes (Optional)</legend>
        <div class="form-row-3">
          <div class="form-group"><label data-i18n="gui_ex_port">Exclude Port</label><input id="qt-expt"
              placeholder="e.g. 22"></div>
          <div class="form-group"><label data-i18n="gui_ex_src">Exclude Source</label><input id="qt-exsrc"
              placeholder="e.g. env=Kube, 10.9.9.9"></div>
          <div class="form-group"><label data-i18n="gui_ex_dest">Exclude Destination</label><input id="qt-exdst"
              placeholder="e.g. 8.8.8.8"></div>
        </div>
      </fieldset>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="closeModal('modal-qt-filters')" data-i18n="gui_cancel">Cancel</button>
        <button class="btn btn-success" onclick="applyQtFilters()">Apply & Query</button>
      </div>
    </div>
  </div>

  <!-- Quarantine Action Modal -->
  <div class="modal-bg" id="m-quarantine">
    <div class="modal" style="max-width:500px">
      <h2><svg class="icon">
          <use href="#icon-alert"></use>
        </svg> Apply Quarantine</h2>
      <div style="margin-bottom:20px; color:var(--fg); line-height:1.5;">
        You are about to isolate <strong id="q-target-count" style="color:var(--accent2)">1</strong> workload(s).
        <br><small style="color:var(--dim)">This action applies an Illumio Label that modifies the workload's policy
          scope.</small>
      </div>
      <input type="hidden" id="q-target-hrefs" value="">
      <div class="form-group" id="q-direction-grp" style="display:none; margin-bottom: 12px;">
        <label>Which workload to isolate?</label>
        <div class="radio-group" style="display:flex;gap:15px;margin-top:6px;">
          <label style="cursor:pointer;"><input type="radio" name="q-dir" value="source" checked> Source
            Workload</label>
          <label style="cursor:pointer;"><input type="radio" name="q-dir" value="destination"> Destination
            Workload</label>
        </div>
      </div>
      <div class="form-group">
        <label>Isolation Severity Level</label>
        <select id="q-severity" class="severity-select">
          <option value="Mild" style="color:var(--accent2)">Mild (Block External Inbound, Allow Outbound/Internal)
          </option>
          <option value="Moderate" style="color:var(--warn)">Moderate (Block All Inbound, Allow Outbound)</option>
          <option value="Severe" style="color:var(--danger)">Severe (Full Isolation - Block All Inbound/Outbound)
          </option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="closeModal('m-quarantine')">Cancel</button>
        <button class="btn btn-danger" id="btn-apply-q" onclick="applyQuarantine()">Apply Quarantine</button>
      </div>
    </div>
  </div>

  <!-- Event -->
  <div class="modal-bg" id="m-event">
    <div class="modal">
      <h2><span data-i18n="gui_add_event_rule" id="me-title">Add Event Rule</span></h2>
      <div class="form-group"><label data-i18n="gui_category">Category</label><select id="ev-cat"
          onchange="populateEvents()">
          <option value="" data-i18n="gui_select">Select‚Ä¶</option>
        </select></div>
      <div class="form-group"><label data-i18n="gui_event_type">Event Type</label><select id="ev-type">
          <option value="" data-i18n="gui_select_first">Select category first</option>
        </select></div>
      <fieldset>
        <legend data-i18n="gui_threshold">Threshold</legend>
        <div class="form-group"><label data-i18n="gui_type">Type</label>
          <div class="radio-group"><label><input type="radio" name="ev-tt" value="immediate" checked> <span
                data-i18n="gui_tt_immediate">Immediate</span></label><label><input type="radio" name="ev-tt"
                value="count"> <span data-i18n="gui_tt_count">Cumulative</span></label></div>
        </div>
        <div class="form-row-3">
          <div class="form-group"><label data-i18n="gui_count">Count</label><input id="ev-cnt" type="number" value="5">
          </div>
          <div class="form-group"><label data-i18n="gui_window_min">Window (min)</label><input id="ev-win" type="number"
              value="10"></div>
          <div class="form-group"><label data-i18n="gui_cooldown">Cooldown (min)</label><input id="ev-cd" type="number"
              value="10"></div>
        </div>
      </fieldset>
      <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-event')"
          data-i18n="gui_cancel">Cancel</button><button class="btn btn-success" onclick="saveEvent()"
          data-i18n="gui_save">üíæ Save</button></div>
    </div>
  </div>

  <!-- Traffic -->
  <div class="modal-bg" id="m-traffic">
    <div class="modal">
      <h2><span data-i18n="gui_add_traffic_rule" id="mt-title">Add Traffic Rule</span></h2>
      <div class="form-group"><label data-i18n="gui_rule_name">Rule Name</label><input id="tr-name"></div>
      <fieldset>
        <legend data-i18n="gui_policy_dec">Policy Decision</legend>
        <div class="radio-group">
          <label><input type="radio" name="tr-pd" value="2" checked> <span
              data-i18n="gui_pd_blocked">Blocked</span></label>
          <label><input type="radio" name="tr-pd" value="1"> <span data-i18n="gui_pd_potential">Potential</span></label>
          <label><input type="radio" name="tr-pd" value="0"> <span data-i18n="gui_pd_allowed">Allowed</span></label>
          <label><input type="radio" name="tr-pd" value="-1"> <span data-i18n="gui_pd_all">All</span></label>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_col_filters">Filters</legend>
        <div class="form-row">
          <div class="form-group"><label data-i18n="gui_port">Port</label><input id="tr-port"
              placeholder="e.g. 80, 443"></div>
          <div class="form-group"><label data-i18n="gui_protocol">Protocol</label><select id="tr-proto">
              <option value="" data-i18n="gui_both">Both</option>
              <option value="6" data-i18n="gui_tcp">TCP</option>
              <option value="17" data-i18n="gui_udp">UDP</option>
            </select></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label data-i18n="gui_source">Source (Label/IP)</label><input id="tr-src"
              placeholder="e.g. role=Web, 10.0.0.0/8, 192.168.1.1"></div>
          <div class="form-group"><label data-i18n="gui_dest">Destination (Label/IP)</label><input id="tr-dst"
              placeholder="e.g. app=DB, 10.1.1.5"></div>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_excludes">Excludes (Optional)</legend>
        <div class="form-row-3">
          <div class="form-group"><label data-i18n="gui_ex_port">Exclude Port</label><input id="tr-expt"
              placeholder="e.g. 22"></div>
          <div class="form-group"><label data-i18n="gui_ex_src">Exclude Source</label><input id="tr-exsrc"
              placeholder="e.g. env=Kube, 10.9.9.9"></div>
          <div class="form-group"><label data-i18n="gui_ex_dest">Exclude Destination</label><input id="tr-exdst"
              placeholder="e.g. 8.8.8.8"></div>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_threshold">Threshold</legend>
        <div class="form-row-3">
          <div class="form-group"><label data-i18n="gui_count">Count</label><input id="tr-cnt" type="number" value="10">
          </div>
          <div class="form-group"><label data-i18n="gui_window_min">Window (min)</label><input id="tr-win" type="number"
              value="10"></div>
          <div class="form-group"><label data-i18n="gui_cooldown">Cooldown (min)</label><input id="tr-cd" type="number"
              value="10"></div>
        </div>
      </fieldset>
      <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-traffic')"
          data-i18n="gui_cancel">Cancel</button><button class="btn btn-success" onclick="saveTraffic()"
          data-i18n="gui_save">üíæ Save</button></div>
    </div>
  </div>

  <!-- BW/Volume -->
  <div class="modal-bg" id="m-bw">
    <div class="modal">
      <h2><span data-i18n="gui_add_bw_rule" id="mb-title">Add Bandwidth / Volume Rule</span></h2>
      <div class="form-group"><label data-i18n="gui_rule_name">Rule Name</label><input id="bw-name"></div>
      <fieldset>
        <legend data-i18n="gui_metric_type">Metric Type</legend>
        <div class="radio-group">
          <label><input type="radio" name="bw-mt" value="bandwidth" checked> <span data-i18n="gui_mt_bw">Bandwidth
              (Mbps, Max)</span></label>
          <label><input type="radio" name="bw-mt" value="volume"> <span data-i18n="gui_mt_vol">Volume (MB,
              Sum)</span></label>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_policy_dec">Policy Decision</legend>
        <div class="radio-group">
          <label><input type="radio" name="bw-pd" value="2"> <span data-i18n="gui_pd_blocked">Blocked</span></label>
          <label><input type="radio" name="bw-pd" value="1"> <span data-i18n="gui_pd_potential">Potential</span></label>
          <label><input type="radio" name="bw-pd" value="0"> <span data-i18n="gui_pd_allowed">Allowed</span></label>
          <label><input type="radio" name="bw-pd" value="-1" checked> <span data-i18n="gui_pd_all">All</span></label>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_col_filters">Filters</legend>
        <div class="form-row-3">
          <div class="form-group"><label data-i18n="gui_port">Port</label><input id="bw-port" placeholder="e.g. 443">
          </div>
          <div class="form-group"><label data-i18n="gui_source">Source (Label/IP)</label><input id="bw-src"
              placeholder="e.g. role=Web, 10.0.0.0/8"></div>
          <div class="form-group"><label data-i18n="gui_dest">Destination (Label/IP)</label><input id="bw-dst"
              placeholder="e.g. app=DB, 10.1.1.5"></div>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_excludes">Excludes (Optional)</legend>
        <div class="form-row-3">
          <div class="form-group"><label data-i18n="gui_ex_port">Exclude Port</label><input id="bw-expt"
              placeholder="e.g. 22"></div>
          <div class="form-group"><label data-i18n="gui_ex_src">Exclude Source</label><input id="bw-exsrc"
              placeholder="e.g. env=Kube, 10.9.9.9"></div>
          <div class="form-group"><label data-i18n="gui_ex_dest">Exclude Destination</label><input id="bw-exdst"
              placeholder="e.g. 8.8.8.8"></div>
        </div>
      </fieldset>
      <fieldset>
        <legend data-i18n="gui_threshold">Threshold</legend>
        <div class="form-row-3">
          <div class="form-group"><label data-i18n="gui_value">Value</label><input id="bw-val" type="number"
              value="100"></div>
          <div class="form-group"><label data-i18n="gui_window_min">Window (min)</label><input id="bw-win" type="number"
              value="10"></div>
          <div class="form-group"><label data-i18n="gui_cooldown">Cooldown (min)</label><input id="bw-cd" type="number"
              value="30"></div>
        </div>
      </fieldset>
      <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-bw')"
          data-i18n="gui_cancel">Cancel</button><button class="btn btn-success" onclick="saveBW()"
          data-i18n="gui_save">üíæ Save</button></div>
    </div>
  </div>

  <!-- Help / Parameter Guide -->
  <div class="modal-bg" id="m-help">
    <div class="modal" style="max-width:600px;">
      <h2>üìñ Parameter Guide (API 25.2)</h2>
      <div style="color:var(--dim);line-height:1.6;font-size:0.95rem;">
        <p>Illumio PCE Monitor leverages the standard Illumio Traffic Analysis REST API parameters.</p>
        <h3 style="color:#fff;margin-top:12px">Filters & Excludes</h3>
        <ul style="padding-left:20px;margin-bottom:12px">
          <li><strong>Label format:</strong> <code>key=value</code> (e.g., <code>role=Web</code>,
            <code>env=Production</code>, <code>app=Database</code>). Must exactly match the PCE label keys and values.
          </li>
          <li><strong>IP List/CIDR format:</strong> Standard CIDR notation (e.g., <code>10.0.0.0/8</code>) or exact
            IPs
            (e.g., <code>192.168.1.50</code>).</li>
          <li><strong>Port format:</strong> Integer port numbers (e.g., <code>80</code>, <code>443</code>,
            <code>3306</code>).
          </li>
        </ul>

        <h3 style="color:#fff;margin-top:12px">Policy Decisions</h3>
        <ul style="padding-left:20px;margin-bottom:12px">
          <li><strong>Blocked:</strong> Traffic explicitly dropped by policy.</li>
          <li><strong>Potential:</strong> Traffic that <em>would</em> be blocked if the workload were placed into
            Enforced mode.</li>
          <li><strong>Allowed:</strong> Traffic permitted by policy.</li>
        </ul>
      </div>
      <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-help')">Close window</button>
      </div>
    </div>
  </div>

  <!-- Traffic Analyzer Parameter Guide Modal -->
  <div class="modal-bg" id="modal-qt-guide">
    <div class="modal" style="max-width:700px;">
      <h2><span data-i18n="gui_ta_guide_title">Traffic Analyzer Parameter Guide</span></h2>
      <div style="color:var(--dim); line-height:1.6; font-size:0.95rem; max-height:60vh; overflow-y:auto;">
        <p style="color:var(--fg); font-weight:bold; margin-bottom:12px;" data-i18n="gui_ta_guide_desc">Use 'Filter
          Details' to search for process names, users, or workload names.</p>

        <h3 style="color:var(--accent2); margin-top:15px; border-bottom:1px solid var(--border); padding-bottom:5px;"
          data-i18n="gui_ta_guide_sec_search">Filter Details / Quick Search</h3>
        <p data-i18n="gui_ta_guide_search_desc">This field performs real-time matching on the returned results (supports
          top 500 records), matching:</p>
        <ul style="padding-left:20px; margin-bottom:12px;">
          <li data-i18n="gui_ta_guide_li_proc">Process Name (Process): e.g. sshd, nginx, java</li>
          <li data-i18n="gui_ta_guide_li_user">User Name (User): e.g. root, www-data, system</li>
          <li data-i18n="gui_ta_guide_li_svc">Service Name (Service): e.g. HTTPS, MySQL</li>
          <li data-i18n="gui_ta_guide_li_wn">Workload Name: e.g. web-server-01</li>
          <li data-i18n="gui_ta_guide_li_ip">IP Address: e.g. 10.0.0.1</li>
          <li data-i18n="gui_ta_guide_li_port">Port: e.g. 443</li>
        </ul>

        <h3 style="color:var(--accent2); margin-top:15px; border-bottom:1px solid var(--border); padding-bottom:5px;"
          data-i18n="gui_ta_guide_sec_adv">Advanced Filter Settings</h3>
        <p data-i18n="gui_ta_guide_adv_desc">These parameters are sent directly to the Illumio API for server-side
          filtering:</p>
        <ul style="padding-left:20px; margin-bottom:12px;">
          <li data-i18n="gui_ta_guide_li_labels">Labels: Use Key=Value format, e.g. role=Web</li>
          <li data-i18n="gui_ta_guide_li_excludes">Excludes: Exclude specific ports, labels, or IP ranges</li>
          <li data-i18n="gui_ta_guide_li_pd">Policy Decision: Filter by decisions (Blocked, Allowed, etc.)</li>
        </ul>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" onclick="closeModal('modal-qt-guide')" data-i18n="gui_cancel">Close</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const $ = s => document.getElementById(s);
    const api = async (url, opt) => { const r = await fetch(url, opt); return r.json() };
    const post = (url, body) => api(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    const put = (url, body) => api(url, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    const del = url => api(url, { method: 'DELETE' });
    const rv = name => document.querySelector(`input[name="${name}"]:checked`)?.value;
    const setRv = (name, val) => { const r = document.querySelector(`input[name="${name}"][value="${val}"]`); if (r) r.checked = true };
    let _editIdx = null; // null = add mode, number = edit mode
    let _dashboardQueries = [];

    let _translations = {};
    let _timezone = 'local';

    function formatDateZ(utcString) {
      if (!utcString) return "";
      let d = new Date(utcString);
      if (isNaN(d.getTime())) {
        if (!utcString.endsWith('Z')) {
          d = new Date(utcString + 'Z');
        }
      }
      if (isNaN(d.getTime())) return utcString;

      let targetDate = d;
      if (_timezone !== 'local' && _timezone.startsWith('UTC')) {
        let offsetStr = _timezone.replace('UTC', '');
        let offsetHours = parseFloat(offsetStr) || 0;
        let ms = d.getTime() + (offsetHours * 3600000);
        targetDate = new Date(ms);
        const pad = n => n.toString().padStart(2, '0');
        return `${targetDate.getUTCFullYear()}-${pad(targetDate.getUTCMonth() + 1)}-${pad(targetDate.getUTCDate())} ${pad(targetDate.getUTCHours())}:${pad(targetDate.getUTCMinutes())}:${pad(targetDate.getUTCSeconds())}`;
      } else {
        const pad = n => n.toString().padStart(2, '0');
        return `${targetDate.getFullYear()}-${pad(targetDate.getMonth() + 1)}-${pad(targetDate.getDate())} ${pad(targetDate.getHours())}:${pad(targetDate.getMinutes())}:${pad(targetDate.getSeconds())}`;
      }
    }

    let _labelDimensions = {
      'role': { bg: '#ce93d8', fg: '#ffffff' },
      'app': { bg: '#42a5f5', fg: '#ffffff' },
      'env': { bg: '#26a69a', fg: '#ffffff' },
      'loc': { bg: '#857ad6', fg: '#ffffff' }
    };

    function sortLabels(labels) {
      if (!labels || !labels.length) return [];
      const order = { 'role': 1, 'app': 2, 'env': 3, 'loc': 4 };
      return labels.slice().sort((a, b) => {
        const keyA = a.key.toLowerCase();
        const keyB = b.key.toLowerCase();
        const rankA = order[keyA] || 99;
        const rankB = order[keyB] || 99;
        if (rankA !== rankB) return rankA - rankB;
        return keyA.localeCompare(keyB);
      });
    }

    function renderLabelsHtml(labels) {
      if (!labels || !labels.length) return '';
      return sortLabels(labels).map(l => {
        const cMap = _labelDimensions[l.key] || { bg: '#e1ecf4', fg: '#2c5e77' };
        const cssDef = `background:${cMap.bg};color:${cMap.fg};padding:1px 4px;border-radius:4px;font-size:9px;margin-right:2px;display:inline-block;white-space:nowrap;margin-top:2px;`;
        let classStr = 'lbl';
        if (l.key === 'Quarantine') classStr += ' lbl-quarantine';
        return `<span class="${classStr}" style="${cssDef}">${escapeHtml(l.key)}:${escapeHtml(l.value)}</span>`;
      }).join('');
    }

    let _activePopover = null;

    function showCellPopover(event, title, items) {
      event.stopPropagation();
      if (_activePopover) {
        _activePopover.remove();
        _activePopover = null;
      }

      const pop = document.createElement('div');
      pop.className = 'cell-popover';

      let html = `<h4>${escapeHtml(title)} (${items.length} ITEMS)</h4><ul>`;
      items.forEach(it => { html += `<li>${escapeHtml(it)}</li>`; });
      html += '</ul>';

      pop.innerHTML = html;
      document.body.appendChild(pop);

      const rect = event.currentTarget.getBoundingClientRect();
      const popRect = pop.getBoundingClientRect();

      let top = rect.bottom + window.scrollY + 5;
      let left = rect.left + window.scrollX;

      // Ensure it doesn't go off screen
      if (left + popRect.width > window.innerWidth) {
        left = window.innerWidth - popRect.width - 20;
      }
      if (top + popRect.height > window.innerHeight + window.scrollY) {
        top = rect.top + window.scrollY - popRect.height - 5;
      }

      pop.style.top = top + 'px';
      pop.style.left = left + 'px';

      _activePopover = pop;
    }

    document.addEventListener('click', function (e) {
      if (_activePopover && !_activePopover.contains(e.target)) {
        _activePopover.remove();
        _activePopover = null;
      }
    });

    async function init() {
      await loadTranslations();
      await loadStatus();
      await loadDashboardQueries();
      setInterval(loadStatus, 30000);
      hideAll();
    }

    function hideAll() {
      // Helper to close popovers when clicking outside
    }

    async function loadTranslations() {
      _translations = await api('/api/ui_translations');
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const k = el.getAttribute('data-i18n');
        if (_translations[k]) {
          if (el.tagName === 'INPUT' && el.type === 'button') el.value = _translations[k];
          else el.textContent = _translations[k];
        }
      });
    }

    function initTableResizers() {
      document.querySelectorAll('.rule-table').forEach(table => {
        const ths = table.querySelectorAll('th');
        ths.forEach(th => {
          if (th.querySelector('.resizer')) return;
          const resizer = document.createElement('div');
          resizer.classList.add('resizer');
          th.appendChild(resizer);
          let startX, startWidth;
          resizer.addEventListener('mousedown', function (e) {
            startX = e.pageX;
            startWidth = th.offsetWidth;
            document.body.style.cursor = 'col-resize';
            const onMouseMove = (e) => {
              const newWidth = startWidth + (e.pageX - startX);
              th.style.width = Math.max(newWidth, 30) + 'px';
            };
            const onMouseUp = () => {
              document.body.style.cursor = 'default';
              document.removeEventListener('mousemove', onMouseMove);
              document.removeEventListener('mouseup', onMouseUp);
            };
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
          });
        });
      });
    }

    function toast(msg, err) { const t = $('toast'); t.textContent = msg; t.className = 'toast' + (err ? ' err' : '') + ' show'; setTimeout(() => t.className = 'toast', 3000) }
    function dlog(msg) { const l = $('d-log'); l.textContent += '\n[' + new Date().toLocaleTimeString() + '] ' + msg; l.scrollTop = l.scrollHeight }
    function slog(msg) { const l = $('s-log'); if (l) { l.textContent += '\n[' + new Date().toLocaleTimeString() + '] ' + msg; l.scrollTop = l.scrollHeight } }
    function alog(msg) { const l = $('a-log'); l.textContent += '\n' + msg; l.scrollTop = l.scrollHeight }

    /* ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function switchTab(id) {
      document.querySelectorAll('.tab').forEach((t, i) => { t.classList.toggle('active', t.textContent.trim().toLowerCase().startsWith(id.slice(0, 4))) });
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      $('p-' + id).classList.add('active');
      if (id === 'rules') loadRules();
      if (id === 'settings') loadSettings();
      if (id === 'dashboard') loadDashboard();
    }

    /* ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    async function loadDashboard() {
      const d = await api('/api/status');
      $('hdr-meta').textContent = `v${d.version} | ${d.api_url}`;
      $('d-rules').textContent = d.rules_count;
      $('d-health').textContent = d.health_check ? 'ON' : 'OFF';
      $('d-lang').textContent = (d.language || 'en').toUpperCase();
      if (d.timezone) _timezone = d.timezone;
      if (d.theme) document.documentElement.setAttribute('data-theme', d.theme);

      if (d.cooldowns && d.cooldowns.length > 0) {
        const activeCds = d.cooldowns.filter(c => c.remaining_mins > 0).length;
        if (activeCds > 0) {
          const title = _translations['gui_cooldown_title'] || 'Rules in Cooldown';
          $('cd-field').style.display = 'block';
          $('cd-list').innerHTML = `<div class="card" style="border-color:var(--warn);"><div class="label" style="color:var(--warn);"><span style="margin-right:4px;">‚è≥</span>${title}</div><div class="value" style="color:var(--warn);">${activeCds}</div></div>`;
        } else {
          $('cd-field').style.display = 'none';
          $('cd-list').innerHTML = '';
        }
      } else {
        $('cd-field').style.display = 'none';
        $('cd-list').innerHTML = '';
      }

      await loadTranslations();
      await loadDashboardQueries();
    }
    async function testConn() {
      slog('Testing PCE connection...');
      const r = await post('/api/actions/test-connection', {});
      if (r.ok) { $('d-api').textContent = 'Connected'; $('d-api').className = 'value ok'; slog('‚úÖ Connected (HTTP ' + r.status + ')') }
      else { $('d-api').textContent = 'Error'; $('d-api').className = 'value err'; slog('‚ùå ' + (r.error || r.body)) }
    }

    async function loadDashboardQueries() {
      const rt = await window.fetch('/api/dashboard/queries');
      _dashboardQueries = await rt.json() || [];
      renderDashboardQueries();
    }

    const escapeHtml = (unsafe) => {
      return (unsafe || '').toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    function renderDashboardQueries() {
      const container = $('d-queries-container');
      let html = '';
      if (_dashboardQueries.length === 0) {
        html = `<div style="text-align:center;padding:20px;color:var(--dim);font-size:0.9rem;">${_translations['gui_top10_empty'] || 'No data.'}</div>`;
      } else {
        _dashboardQueries.forEach((q, i) => {
          let badgeColor = "var(--primary)";
          if (q.pd === 2) badgeColor = "var(--danger)";
          else if (q.pd === 1) badgeColor = "var(--warn)";
          else if (q.pd === 0) badgeColor = "var(--success)";

          let rankLabel = q.rank_by === 'bandwidth' ? (_translations['gui_rank_bw'] || 'Max Bandwidth (Mbps)') : (q.rank_by === 'volume' ? (_translations['gui_rank_vol'] || 'Total Volume (MB)') : (_translations['gui_rank_conn'] || 'Connection Count'));
          html += `
          <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;">
             <div style="display:flex;align-items:center;min-height:30px;">
                <strong style="margin-right:12px;font-size:0.95rem;color:var(--accent2);">${escapeHtml(q.name)}</strong>
                <span style="font-size:10px;background:${badgeColor};color:#fff;padding:2px 6px;border-radius:4px;margin-right:8px;">PD: ${q.pd === 3 ? (_translations['gui_pd_all'] || 'All') : (q.pd === 2 ? (_translations['gui_pd_blocked'] || 'Blocked') : (q.pd === 1 ? (_translations['gui_pd_potential'] || 'Potential') : (_translations['gui_pd_allowed'] || 'Allowed')))}</span>
                <span style="font-size:10px;background:var(--dim);color:#fff;padding:2px 6px;border-radius:4px;margin-right:8px;">${rankLabel}</span>
                <span style="flex:1"></span>
                <span id="d-qstate-${i}" style="color:var(--dim);font-size:0.8rem;margin-right:12px;"></span>
                <button class="btn btn-sm" style="background:var(--bg);border:1px solid var(--border);margin-right:6px;" onclick="openQueryModal(${i})">‚úèÔ∏è</button>
                <button class="btn btn-primary btn-sm" onclick="runTop10Query(${i})" data-i18n="gui_run_btn">Run</button>
             </div>
             
              <table class="rule-table" style="margin-top:10px;border-top:1px solid var(--border);font-size:0.8rem;">
               <thead><tr>
                 <th style="width:25px">#</th>
                 <th style="width:100px" data-i18n="gui_value">Value</th>
                 <th style="width:110px">First/Last Seen</th>
                 <th>Source</th>
                 <th>Destination</th>
                 <th style="width:70px">Service</th>
                 <th style="width:70px" data-i18n="gui_policy_dec">Decision</th>
                 <th style="width:140px">Actions</th>
               </tr></thead>
               <tbody id="d-qbody-${i}">
                <tr><td colspan="8" style="text-align:center;color:var(--dim);padding:20px;">${_translations['gui_top10_empty'] || 'No data. Click Run to query.'}</td></tr>
              </tbody>
             </table>
          </div>`;
        });
      }
      container.innerHTML = html;
      initTableResizers();

      if (typeof applyLang === "function") applyLang();
      else loadTranslations().catch(console.error);
    }

    function openQueryModal(idx = -1) {
      $('dq-idx').value = idx;
      if (idx < 0) {
        $('mq-title').textContent = _translations['gui_add_query_widget'] || 'Add Query Widget';
        $('dq-name').value = '';
        $('dq-rank').value = 'count';
        document.querySelector('input[name="dq-pd"][value="3"]').checked = true;
        $('dq-port').value = ''; $('dq-proto').value = '';
        $('dq-src').value = ''; $('dq-dst').value = '';
        $('dq-expt').value = ''; $('dq-exsrc').value = ''; $('dq-exdst').value = '';
      } else {
        $('mq-title').textContent = 'Edit Query Widget';
        const q = _dashboardQueries[idx];
        $('dq-name').value = q.name || '';
        $('dq-rank').value = q.rank_by || 'count';
        const pdRad = document.querySelector(`input[name="dq-pd"][value="${q.pd}"]`);
        if (pdRad) pdRad.checked = true;
        $('dq-port').value = q.port || '';
        $('dq-proto').value = q.proto || '';
        $('dq-src').value = (q.src_label || '') + (q.src_ip_in ? (q.src_label ? ', ' : '') + q.src_ip_in : '');
        $('dq-dst').value = (q.dst_label || '') + (q.dst_ip_in ? (q.dst_label ? ', ' : '') + q.dst_ip_in : '');
        $('dq-expt').value = q.ex_port || '';
        $('dq-exsrc').value = (q.ex_src_label || '') + (q.ex_src_ip ? (q.ex_src_label ? ', ' : '') + q.ex_src_ip : '');
        $('dq-exdst').value = (q.ex_dst_label || '') + (q.ex_dst_ip ? (q.ex_dst_label ? ', ' : '') + q.ex_dst_ip : '');
      }
      let btn = document.querySelector('#m-query .modal-actions');
      let isEdit = idx >= 0;
      if (isEdit && !document.getElementById('m-query-del')) {
        let delBtn = document.createElement('button');
        delBtn.id = 'm-query-del';
        delBtn.className = 'btn btn-danger';
        delBtn.innerText = _translations['gui_delete'] || 'Delete';
        delBtn.style.marginRight = 'auto';
        delBtn.onclick = () => deleteTop10Query(idx);
        btn.insertBefore(delBtn, btn.firstChild);
      } else if (!isEdit && document.getElementById('m-query-del')) {
        document.getElementById('m-query-del').remove();
      }

      const m = $('m-query');
      if (m) m.classList.add('show');
    }

    async function saveDashboardQuery() {
      const idx = parseInt($('dq-idx').value);
      const pdMatch = document.querySelector('input[name="dq-pd"]:checked');
      const d = {
        idx: idx >= 0 ? idx : null,
        name: $('dq-name').value,
        rank_by: $('dq-rank').value,
        pd: pdMatch ? parseInt(pdMatch.value) : 3,
        port: parseInt($('dq-port').value) || null,
        proto: parseInt($('dq-proto').value) || null,
        src: $('dq-src').value, dst: $('dq-dst').value,
        ex_port: parseInt($('dq-expt').value) || null,
        ex_src: $('dq-exsrc').value, ex_dst: $('dq-exdst').value
      };

      // Quick API helper if not strictly using fetch directly
      const r = await fetch('/api/dashboard/queries', {
        method: 'POST', body: JSON.stringify(d), headers: { 'Content-Type': 'application/json' }
      }).then(res => res.json());

      if (r.ok) {
        const m = $('m-query');
        if (m) m.classList.remove('show');
        await loadDashboardQueries();
      }
      else alert("Error: " + r.error);
    }

    async function deleteTop10Query(idx) {
      if (!confirm("Delete this widget?")) return;
      const r = await fetch('/api/dashboard/queries/' + idx, { method: 'DELETE' }).then(res => res.json());
      if (r.ok) {
        const m = $('m-query');
        if (m) m.classList.remove('show');
        await loadDashboardQueries();
      }
      else alert("Delete failed");
    }

    async function runAllQueries() {
      for (let i = 0; i < _dashboardQueries.length; i++) {
        await runTop10Query(i);
      }
    }

    async function runTop10Query(idx) {
      const q = _dashboardQueries[idx];
      const ms = $(`d-qstate-${idx}`), bd = $(`d-qbody-${idx}`);
      if (!ms || !bd) return;

      const payload = { ...q, mins: parseInt($('d-global-min').value) || 30 };

      ms.textContent = _translations['gui_top10_querying'] || 'Querying...';
      bd.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--dim);padding:20px;">${_translations['gui_top10_loading'] || 'Loading...'}</td></tr>`;

      try {
        const r = await fetch('/api/dashboard/top10', {
          method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' }
        }).then(res => res.json());
        if (!r.ok) throw new Error(r.error || 'Unknown error');

        if (r.data && r.data.length) {
          let html = '';
          r.data.forEach((m, i) => {
            const pBadge = m.pd === 2 ? `<span style="background:var(--danger);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">${_translations['gui_pd_blocked'] || 'Blocked'}</span>` :
              m.pd === 1 ? `<span style="background:var(--warn);color:#000;padding:2px 6px;border-radius:4px;font-size:10px;">${_translations['gui_pd_potential'] || 'Potential'}</span>` :
                m.pd === 0 ? `<span style="background:var(--success);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">${_translations['gui_pd_allowed'] || 'Allowed'}</span>` : m.pd;

            const sLabels = renderLabelsHtml(m.s_labels);
            const dLabels = renderLabelsHtml(m.d_labels);

            let isoBtn = '';
            if (m.s_href && m.d_href) {
              isoBtn = `<button class="btn btn-secondary btn-sm" onclick="openQuarantineModal('${m.s_href}', false, '${m.d_href}')">Isolate</button>`;
            } else if (m.s_href || m.d_href) {
              isoBtn = `<button class="btn btn-secondary btn-sm" onclick="openQuarantineModal('${m.s_href || m.d_href}')">Isolate</button>`;
            }

            const formatActor = (name, ip, href, labelsHtml, process, user) => {
              let procStr = '';
              if (process || user) {
                let p = process ? `<span style="color:var(--accent); font-weight:bold;"><i class="fas fa-microchip"></i> Process: ${escapeHtml(process)}</span>` : '';
                let u = user ? `<span style="color:var(--accent2);"><i class="fas fa-user"></i> User: ${escapeHtml(user)}</span>` : '';
                let sep = (p && u) ? '<br>' : '';
                procStr = `<div style="font-size:10px; margin-top:4px;">${p}${sep}${u}</div>`;
              }
              let a = href ? `<a href="#" style="color:var(--text);font-weight:bold;font-size:11px;">${escapeHtml(name)}</a>` : `<strong style="font-size:11px;">${escapeHtml(name)}</strong>`;
              return `${a}<br><small style="color:var(--dim);">${escapeHtml(ip)}</small>${procStr}<div style="margin-top:2px;">${labelsHtml}</div>`;
            };

            let svc_str = escapeHtml(m.svc);
            if (m.svc.length > 25) {
              let arr = m.svc.split(',').map(s => s.trim());
              let encJson = encodeURIComponent(JSON.stringify(arr));
              svc_str = `<span onclick="showCellPopover(event, 'SVC', JSON.parse(decodeURIComponent('${encJson}')))" style="cursor:pointer; border-bottom:1px dotted var(--dim); color:var(--accent);">${escapeHtml(m.svc.substring(0, 23))}...</span>`;
            }

            html += `
          <tr>
            <td>${i + 1}</td>
            <td style="font-weight:bold;color:#6f42c1;">${m.val_fmt}</td>
            <td style="font-size:10px;white-space:nowrap;">${formatDateZ(m.first_seen)}<br>${formatDateZ(m.last_seen)}</td>
            <td>${formatActor(m.s_name, m.s_ip, m.s_href, sLabels, m.s_process, m.s_user)}</td>
            <td>${formatActor(m.d_name, m.d_ip, m.d_href, dLabels, m.d_process, m.d_user)}</td>
            <td>${svc_str}</td>
            <td>${pBadge}</td>
            <td>${isoBtn}</td>
          </tr>`;
          });
          bd.innerHTML = html;
          ms.textContent = (_translations['gui_top10_found'] || 'Found {count} records. (Top 10)').replace('{count}', r.total);
        } else {
          bd.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--dim);padding:20px;">${_translations['gui_top10_no_records'] || 'No records found.'}</td></tr>`;
          ms.textContent = _translations['gui_done'] || 'Done.';
        }
        initTableResizers();
      } catch (e) {
        ms.textContent = 'Error: ' + e.message;
        bd.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--danger);padding:20px;">${_translations['gui_top10_error'] || 'Error querying data.'}</td></tr>`;
      }
    }

    /* ‚îÄ‚îÄ‚îÄ Rules ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let _catalog = {};
    async function loadRules() {
      const rules = await api('/api/rules');
      $('r-badge').textContent = rules.length;
      const pdm = { 2: 'Blocked', 1: 'Potential', 0: 'Allowed', '-1': 'All' };

      const cdTitle = _translations['gui_cooldown_active'] || 'Cooldown';
      const readyTitle = _translations['gui_cooldown_ready'] || 'Ready';
      const remTempl = _translations['gui_cooldown_remaining'] || '{mins}m remaining';

      let html = '';
      rules.forEach(r => {
        const typ = r.type.charAt(0).toUpperCase() + r.type.slice(1);
        const unit = { volume: ' MB', bandwidth: ' Mbps', traffic: ' conns' }[r.type] || '';
        const cond = '> ' + r.threshold_count + unit + ' (Win:' + r.threshold_window + 'm CD:' + (r.cooldown_minutes || r.threshold_window) + 'm)';

        let statusHtml = '';
        if (r.cooldown_remaining > 0) {
          const rem = remTempl.replace('{mins}', r.cooldown_remaining);
          statusHtml = `<span style="background:var(--warn);color:#1a2c32;padding:2px 6px;border-radius:4px;font-size:0.75rem;font-weight:600;">‚è≥ ${cdTitle} (${rem})</span>`;
        } else {
          statusHtml = `<span style="background:var(--success);color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;font-weight:600;">‚úÖ ${readyTitle}</span>`;
        }

        let f = [];
        if (r.type === 'event') f.push('Event: ' + r.filter_value);
        if (r.pd !== undefined && r.pd !== null) f.push('PD:' + (pdm[r.pd] || r.pd));
        if (r.port) f.push('Port:' + r.port);
        if (r.src_label) f.push('Src:' + r.src_label); if (r.dst_label) f.push('Dst:' + r.dst_label);
        if (r.src_ip_in) f.push('SrcIP:' + r.src_ip_in); if (r.dst_ip_in) f.push('DstIP:' + r.dst_ip_in);
        html += `<tr><td><input type="checkbox" class="r-chk" data-idx="${r.index}"></td><td title="${typ}">${typ}</td><td title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</td><td>${statusHtml}</td><td title="${cond}">${cond}</td><td title="${escapeHtml(f.join(' | '))}">${escapeHtml(f.join(' | ')) || '‚Äî'}</td><td><button class="btn btn-primary btn-sm" onclick="editRule(${r.index},'${r.type}')">‚úèÔ∏è</button></td></tr>`;
      });
      $('r-body').innerHTML = html || '<tr><td colspan="7" style="color:var(--dim);text-align:center;padding:24px">No rules. Add one above.</td></tr>';
      initTableResizers();
    }
    function toggleAll(el) { document.querySelectorAll('.r-chk').forEach(c => c.checked = el.checked) }
    async function deleteSelected() {
      const ids = [...document.querySelectorAll('.r-chk:checked')].map(c => parseInt(c.dataset.idx)).sort((a, b) => b - a);
      if (!ids.length) { toast('Select rules first', 'err'); return }
      if (!confirm('Delete ' + ids.length + ' rule(s)?')) return;
      for (const i of ids) await del('/api/rules/' + i);
      toast('Deleted'); loadRules(); loadDashboard();
    }
    function openModal(id, isEdit) {
      _editIdx = isEdit ?? null; $(id).classList.add('show'); if (id === 'm-event' && !Object.keys(_catalog).length) loadCatalog();
      // Update modal title
      let target;
      if (id === 'm-event') target = $('me-title');
      else if (id === 'm-traffic') target = $('mt-title');
      else if (id === 'm-bw') target = $('mb-title');
      if (target) {
        const baseKey = id === 'm-event' ? 'gui_add_event_rule' : id === 'm-traffic' ? 'gui_add_traffic_rule' : 'gui_add_bw_rule';
        const editKey = id === 'm-event' ? 'gui_edit_event_rule' : id === 'm-traffic' ? 'gui_edit_traffic_rule' : 'gui_edit_bw_rule';
        const key = _editIdx !== null ? editKey : baseKey;
        target.setAttribute('data-i18n', key);
        if (_translations[key]) target.textContent = _translations[key];
      }
    }
    function closeModal(id) { $(id).classList.remove('show'); _editIdx = null }
    async function loadCatalog() {
      _catalog = await api('/api/event-catalog');
      const sel = $('ev-cat'); sel.innerHTML = '<option value="">Select...</option>';
      Object.keys(_catalog).forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o) });
    }
    function populateEvents() {
      const cat = $('ev-cat').value; const sel = $('ev-type'); sel.innerHTML = '';
      if (!cat || !_catalog[cat]) { sel.innerHTML = '<option>Select category first</option>'; return }
      Object.entries(_catalog[cat]).forEach(([k, v]) => { const o = document.createElement('option'); o.value = k; o.textContent = k + ' (' + v + ')'; sel.appendChild(o) });
    }

    /* ‚îÄ‚îÄ‚îÄ Edit Rule ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    async function editRule(idx, type) {
      try {
        const r = await api('/api/rules/' + idx);
        if (!r || r.error) { toast('Rule not found', 'err'); return }
        if (type === 'event') {
          await loadCatalog();
          // Find and select category
          for (const [cat, evts] of Object.entries(_catalog)) {
            if (r.filter_value in evts) { $('ev-cat').value = cat; populateEvents(); $('ev-type').value = r.filter_value; break }
          }
          setRv('ev-tt', r.threshold_type || 'immediate');
          $('ev-cnt').value = r.threshold_count || 5;
          $('ev-win').value = r.threshold_window || 10;
          $('ev-cd').value = r.cooldown_minutes || 10;
          openModal('m-event', idx);
        } else if (type === 'traffic') {
          $('tr-name').value = r.name || '';
          setRv('tr-pd', String(r.pd ?? 2));
          $('tr-port').value = r.port || '';
          $('tr-proto').value = r.proto ? String(r.proto) : '';
          $('tr-src').value = r.src_label || r.src_ip_in || '';
          $('tr-dst').value = r.dst_label || r.dst_ip_in || '';
          $('tr-expt').value = r.ex_port || '';
          $('tr-exsrc').value = r.ex_src_label || r.ex_src_ip || '';
          $('tr-exdst').value = r.ex_dst_label || r.ex_dst_ip || '';
          $('tr-cnt').value = r.threshold_count || 10;
          $('tr-win').value = r.threshold_window || 10;
          $('tr-cd').value = r.cooldown_minutes || 10;
          openModal('m-traffic', idx);
        } else {
          $('bw-name').value = r.name || '';
          setRv('bw-mt', r.type || 'bandwidth');
          setRv('bw-pd', String(r.pd ?? -1));
          $('bw-port').value = r.port || '';
          $('bw-src').value = r.src_label || r.src_ip_in || '';
          $('bw-dst').value = r.dst_label || r.dst_ip_in || '';
          $('bw-expt').value = r.ex_port || '';
          $('bw-exsrc').value = r.ex_src_label || r.ex_src_ip || '';
          $('bw-exdst').value = r.ex_dst_label || r.ex_dst_ip || '';
          $('bw-val').value = r.threshold_count || 100;
          $('bw-win').value = r.threshold_window || 10;
          $('bw-cd').value = r.cooldown_minutes || 30;
          openModal('m-bw', idx);
        }
      } catch (e) {
        console.error(e);
        alert('UI Error: ' + e.message);
      }
    }

    async function saveEvent() {
      const cat = $('ev-cat').value, ev = $('ev-type').value;
      if (!cat || !ev) { toast('Select category and event', 'err'); return }
      const name = (_catalog[cat] || {})[ev] || ev;
      const data = { name, filter_value: ev, threshold_type: rv('ev-tt'), threshold_count: $('ev-cnt').value, threshold_window: $('ev-win').value, cooldown_minutes: $('ev-cd').value };
      if (_editIdx !== null) await put('/api/rules/' + _editIdx, data); else await post('/api/rules/event', data);
      closeModal('m-event'); toast('Event rule saved'); loadRules(); loadDashboard();
    }
    async function saveTraffic() {
      const name = $('tr-name').value.trim(); if (!name) { toast('Name required', 'err'); return }
      const data = { name, pd: rv('tr-pd'), port: $('tr-port').value, proto: $('tr-proto').value, src: $('tr-src').value, dst: $('tr-dst').value, ex_port: $('tr-expt').value, ex_src: $('tr-exsrc').value, ex_dst: $('tr-exdst').value, threshold_count: $('tr-cnt').value, threshold_window: $('tr-win').value, cooldown_minutes: $('tr-cd').value };
      if (_editIdx !== null) await put('/api/rules/' + _editIdx, data); else await post('/api/rules/traffic', data);
      closeModal('m-traffic'); toast('Traffic rule saved'); loadRules(); loadDashboard();
    }
    async function saveBW() {
      const name = $('bw-name').value.trim(); if (!name) { toast('Name required', 'err'); return }
      const data = {
        name, rule_type: rv('bw-mt'), pd: rv('bw-pd'),
        port: $('bw-port').value, src: $('bw-src').value, dst: $('bw-dst').value,
        ex_port: $('bw-expt').value, ex_src: $('bw-exsrc').value, ex_dst: $('bw-exdst').value,
        threshold_count: $('bw-val').value, threshold_window: $('bw-win').value, cooldown_minutes: $('bw-cd').value
      };
      if (_editIdx !== null) await put('/api/rules/' + _editIdx, { ...data, type: data.rule_type }); else await post('/api/rules/bandwidth', data);
      closeModal('m-bw'); toast('Rule saved'); loadRules(); loadDashboard();
    }

    function confirmBestPractices() {
      if (!confirm('‚ö†Ô∏è WARNING: This will DELETE all existing rules and replace them with best practice defaults.\n\nAre you sure you want to continue?')) return;
      if (!confirm('This action cannot be undone. Confirm once more to proceed.')) return;
      runAction('best-practices');
    }

    /* ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let _settings = {};
    async function loadSettings() {
      _settings = await api('/api/settings');
      const s = _settings, a = s.api || {}, e = s.email || {}, sm = s.smtp || {}, al = s.alerts || {}, st = s.settings || {};
      const active = al.active || [];
      $('s-form').innerHTML = `
  <fieldset><legend data-i18n="gui_api_conn">API Connection</legend>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_url">URL</label><input id="s-url" value="${a.url || ''}"></div><div class="form-group"><label data-i18n="gui_org_id">Org ID</label><input id="s-org" value="${a.org_id || ''}"></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_api_key">API Key</label><input id="s-key" value="${a.key || ''}"></div><div class="form-group"><label data-i18n="gui_api_secret">API Secret</label><input id="s-sec" type="password" value="${a.secret || ''}"></div></div>
    <div class="chk"><label><input type="checkbox" id="s-ssl" ${a.verify_ssl ? 'checked' : ''}> <span data-i18n="gui_verify_ssl">Verify SSL</span></label></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_email_smtp">Email & SMTP</legend>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_sender">Sender</label><input id="s-sender" value="${e.sender || ''}"></div><div class="form-group"><label data-i18n="gui_recipients">Recipients (comma)</label><input id="s-rcpt" value="${(e.recipients || []).join(', ')}"></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_smtp_host">SMTP Host</label><input id="s-smhost" value="${sm.host || ''}"></div><div class="form-group"><label data-i18n="gui_port">Port</label><input id="s-smport" value="${sm.port || 25}"></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_user">User</label><input id="s-smuser" value="${sm.user || ''}"></div><div class="form-group"><label data-i18n="gui_password">Password</label><input id="s-smpass" type="password" value="${sm.password || ''}"></div></div>
    <div style="display:flex;gap:20px"><div class="chk"><label><input type="checkbox" id="s-tls" ${sm.enable_tls ? 'checked' : ''}> STARTTLS</label></div><div class="chk"><label><input type="checkbox" id="s-auth" ${sm.enable_auth ? 'checked' : ''}> Auth</label></div></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_alert_channels">Alert Channels</legend>
    <div style="display:flex;gap:20px;margin-bottom:12px"><div class="chk"><label><input type="checkbox" id="s-amail" ${active.includes('mail') ? 'checked' : ''}> üìß <span data-i18n="gui_mail">Mail</span></label></div><div class="chk"><label><input type="checkbox" id="s-aline" ${active.includes('line') ? 'checked' : ''}> üì± <span data-i18n="gui_line">LINE</span></label></div><div class="chk"><label><input type="checkbox" id="s-awh" ${active.includes('webhook') ? 'checked' : ''}> üîó <span data-i18n="gui_webhook">Webhook</span></label></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_line_token">LINE Token</label><input id="s-ltok" value="${al.line_channel_access_token || ''}"></div><div class="form-group"><label data-i18n="gui_line_target_id">LINE Target ID</label><input id="s-ltgt" value="${al.line_target_id || ''}"></div></div>
    <div class="form-group"><label data-i18n="gui_webhook_url">Webhook URL</label><input id="s-whurl" value="${al.webhook_url || ''}"></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_lang_settings">Display & General</legend>
    <div class="chk" style="margin-bottom:12px"><label><input type="checkbox" id="s-hc" ${st.enable_health_check !== false ? 'checked' : ''}> <span data-i18n="gui_enable_hc">Enable PCE Health Check</span></label></div>
    <div class="form-row">
      <div class="form-group">
        <label data-i18n="gui_timezone">Timezone</label>
        <select id="s-timezone" style="width:100%; padding:8px; border-radius:var(--radius); background:var(--bg3); border:1px solid var(--border); color:var(--fg);">
          <option value="local" ${st.timezone === 'local' || !st.timezone ? 'selected' : ''}>Local Browser Time</option>
          <option value="UTC" ${st.timezone === 'UTC' ? 'selected' : ''}>UTC</option>
          <option value="UTC-12" ${st.timezone === 'UTC-12' ? 'selected' : ''}>UTC-12</option>
          <option value="UTC-11" ${st.timezone === 'UTC-11' ? 'selected' : ''}>UTC-11</option>
          <option value="UTC-10" ${st.timezone === 'UTC-10' ? 'selected' : ''}>UTC-10</option>
          <option value="UTC-9" ${st.timezone === 'UTC-9' ? 'selected' : ''}>UTC-9</option>
          <option value="UTC-8" ${st.timezone === 'UTC-8' ? 'selected' : ''}>UTC-8</option>
          <option value="UTC-7" ${st.timezone === 'UTC-7' ? 'selected' : ''}>UTC-7</option>
          <option value="UTC-6" ${st.timezone === 'UTC-6' ? 'selected' : ''}>UTC-6</option>
          <option value="UTC-5" ${st.timezone === 'UTC-5' ? 'selected' : ''}>UTC-5</option>
          <option value="UTC-4" ${st.timezone === 'UTC-4' ? 'selected' : ''}>UTC-4</option>
          <option value="UTC-3" ${st.timezone === 'UTC-3' ? 'selected' : ''}>UTC-3</option>
          <option value="UTC-2" ${st.timezone === 'UTC-2' ? 'selected' : ''}>UTC-2</option>
          <option value="UTC-1" ${st.timezone === 'UTC-1' ? 'selected' : ''}>UTC-1</option>
          <option value="UTC+1" ${st.timezone === 'UTC+1' ? 'selected' : ''}>UTC+1</option>
          <option value="UTC+2" ${st.timezone === 'UTC+2' ? 'selected' : ''}>UTC+2</option>
          <option value="UTC+3" ${st.timezone === 'UTC+3' ? 'selected' : ''}>UTC+3</option>
          <option value="UTC+4" ${st.timezone === 'UTC+4' ? 'selected' : ''}>UTC+4</option>
          <option value="UTC+5" ${st.timezone === 'UTC+5' ? 'selected' : ''}>UTC+5</option>
          <option value="UTC+5.5" ${st.timezone === 'UTC+5.5' ? 'selected' : ''}>UTC+5.5</option>
          <option value="UTC+6" ${st.timezone === 'UTC+6' ? 'selected' : ''}>UTC+6</option>
          <option value="UTC+7" ${st.timezone === 'UTC+7' ? 'selected' : ''}>UTC+7</option>
          <option value="UTC+8" ${st.timezone === 'UTC+8' ? 'selected' : ''}>UTC+8</option>
          <option value="UTC+9" ${st.timezone === 'UTC+9' ? 'selected' : ''}>UTC+9</option>
          <option value="UTC+9.5" ${st.timezone === 'UTC+9.5' ? 'selected' : ''}>UTC+9.5</option>
          <option value="UTC+10" ${st.timezone === 'UTC+10' ? 'selected' : ''}>UTC+10</option>
          <option value="UTC+11" ${st.timezone === 'UTC+11' ? 'selected' : ''}>UTC+11</option>
          <option value="UTC+12" ${st.timezone === 'UTC+12' ? 'selected' : ''}>UTC+12</option>
          <option value="UTC+13" ${st.timezone === 'UTC+13' ? 'selected' : ''}>UTC+13</option>
          <option value="UTC+14" ${st.timezone === 'UTC+14' ? 'selected' : ''}>UTC+14</option>
        </select>
      </div>

      <div class="form-group">
        <label data-i18n="gui_language">Language</label>
        <div class="radio-group">
          <label><input type="radio" name="s-lang" value="en" ${st.language !== 'zh_TW' ? 'checked' : ''}> <span data-i18n="gui_lang_en">English</span></label>
          <label><input type="radio" name="s-lang" value="zh_TW" ${st.language === 'zh_TW' ? 'checked' : ''}> <span data-i18n="gui_lang_zh">ÁπÅÈ´î‰∏≠Êñá</span></label>
        </div>
      </div>
      <div class="form-group">
        <label>Theme</label>
        <div class="radio-group">
          <label><input type="radio" name="s-theme" value="dark" ${st.theme !== 'light' ? 'checked' : ''}> <span data-i18n="gui_theme_dark">Dark Theme</span></label>
          <label><input type="radio" name="s-theme" value="light" ${st.theme === 'light' ? 'checked' : ''}> <span data-i18n="gui_theme_light">Light Theme</span></label>
        </div>
      </div>
    </div>
  </fieldset>`;
      await loadTranslations();
    }
    async function saveSettings() {
      const active = []; if ($('s-amail').checked) active.push('mail'); if ($('s-aline').checked) active.push('line'); if ($('s-awh').checked) active.push('webhook');
      const theme = rv('s-theme');
      const lang = rv('s-lang');
      document.documentElement.setAttribute('data-theme', theme);
      await post('/api/settings', {
        api: { url: $('s-url').value, org_id: $('s-org').value, key: $('s-key').value, secret: $('s-sec').value, verify_ssl: $('s-ssl').checked },
        email: { sender: $('s-sender').value, recipients: $('s-rcpt').value.split(',').map(s => s.trim()).filter(Boolean) },
        smtp: { host: $('s-smhost').value, port: parseInt($('s-smport').value) || 25, user: $('s-smuser').value, password: $('s-smpass').value, enable_tls: $('s-tls').checked, enable_auth: $('s-auth').checked },
        alerts: { active, line_channel_access_token: $('s-ltok').value, line_target_id: $('s-ltgt').value, webhook_url: $('s-whurl').value },
        settings: { language: lang, theme: theme, timezone: $('s-timezone').value, enable_health_check: $('s-hc').checked }
      });
      await loadTranslations();
      if (typeof renderQtPage === 'function') renderQtPage();
      if (typeof renderQwPage === 'function') renderQwPage();
      if (typeof renderDashboardQueries === 'function') renderDashboardQueries();
      toast('Settings saved');
    }

    /* ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    async function runAction(name) {
      $('a-log').textContent = '[' + new Date().toLocaleTimeString() + '] Running ' + name + '...';
      const r = await post('/api/actions/' + name, {});
      alog(r.output || 'Done.');
      if (name === 'best-practices') { loadRules(); loadDashboard() }
      toast('‚úÖ ' + name + ' completed');
    }
    async function runDebug() {
      $('a-log').textContent = '[' + new Date().toLocaleTimeString() + '] Running debug mode...';
      const r = await post('/api/actions/debug', { mins: $('a-debug-mins').value, pd_sel: $('a-debug-pd').value });
      alog(r.output || 'Done.');
      toast('‚úÖ Debug completed');
    }

    /* ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    async function stopGui() {
      if (!confirm('Stop the Web GUI server? The browser page will close.')) return;
      try { await post('/api/shutdown', {}); } catch (e) { }
      document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;gap:12px"><h1 style="color:var(--accent2)">Web GUI Stopped</h1><p style="color:var(--dim)">You may close this tab. Restart from CLI or use --gui.</p></div>';
    }

    /* ‚îÄ‚îÄ‚îÄ Traffic & Quarantine Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */

    // Sub Navigation
    function switchQTab(tabStr) {
      document.querySelectorAll('.sub-nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById('qbtn-' + tabStr).classList.add('active');

      document.querySelectorAll('.q-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('q-panel-' + tabStr).classList.add('active');
    }

    // Checkboxes and Bulk Bar
    function toggleQChecks(clsPrefix) {
      const isAll = document.getElementById(clsPrefix + 'all').checked;
      document.querySelectorAll('.' + clsPrefix).forEach(c => c.checked = isAll);
      updateBulkBar();
    }

    function updateBulkBar() {
      // Check both traffic and workload tables for checks
      const checked = document.querySelectorAll('.qt-chk:checked, .qw-chk:checked');
      const bar = document.getElementById('bulk-bar');
      if (checked.length > 0) {
        document.getElementById('bulk-sel-count').textContent = checked.length;
        bar.classList.add('show');
      } else {
        bar.classList.remove('show');
      }
    }

    // Add event listeners to table bodies for dynamic checkbox listening
    document.addEventListener('change', function (e) {
      if (e.target && (e.target.classList.contains('qt-chk') || e.target.classList.contains('qw-chk'))) {
        updateBulkBar();
      }
    });

    function openQuarantineModal(href, isBulk = false, altHref = null) {
      let targetHrefs = [];
      document.getElementById('q-direction-grp').style.display = 'none';

      if (isBulk) {
        const checked = document.querySelectorAll('.qt-chk:checked, .qw-chk:checked');
        checked.forEach(c => {
          let h = c.value || c.dataset.href;
          if (h && !targetHrefs.includes(h)) targetHrefs.push(h);
        });
        if (targetHrefs.length === 0) return;
      } else {
        if (altHref && href && altHref !== href) {
          // Traffic analyzer flow - need to pick source or dest
          document.getElementById('q-direction-grp').style.display = 'block';
          window._qTempHrefs = { source: href, destination: altHref };
          targetHrefs = [document.querySelector('input[name="q-dir"]:checked').value === 'source' ? href : altHref];
        } else {
          targetHrefs = [href];
        }
      }
      document.getElementById('q-target-count').textContent = targetHrefs.length;
      document.getElementById('q-target-hrefs').value = JSON.stringify(targetHrefs);

      document.getElementById('m-quarantine').classList.add('show');
    }

    async function applyQuarantine() {
      const sev = document.getElementById('q-severity').value;
      const rawHrefs = document.getElementById('q-target-hrefs').value;
      let hrefs = [];
      try { hrefs = JSON.parse(rawHrefs); } catch (e) { }
      if (hrefs.length === 0) return;

      const btn = document.getElementById('btn-apply-q');
      btn.disabled = true;
      btn.innerHTML = `<svg class="icon"><use href="#icon-settings"></use></svg> Applying...`;

      try {
        let r;
        if (hrefs.length === 1) {
          r = await post('/api/quarantine/apply', { href: hrefs[0], level: sev });
        } else {
          r = await post('/api/quarantine/bulk_apply', { hrefs: hrefs, level: sev });
        }

        if (r.ok || r.success) {
          toast(`Isolated ${hrefs.length} workload(s) with ${sev} rules.`);
          closeModal('m-quarantine');
          // Uncheck all
          document.querySelectorAll('.qt-chk, .qw-chk, #qt-chkall, #qw-chkall').forEach(c => c.checked = false);
          updateBulkBar();
          // Refresh tables
          if (document.getElementById('qbtn-workloads').classList.contains('active')) {
            runWorkloadSearch();
          }
        } else {
          throw new Error(r.error || "Failed to apply quarantine");
        }
      } catch (err) {
        alert("Quarantine Apply Error: " + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = `Apply Isolation`;
      }
    }

    const renderSkeletonRow = (cols) => {
      let td = `<div class="skeleton skel-text"></div><div class="skeleton skel-text short"></div>`;
      let res = `<tr class="skel-tr">`;
      for (let i = 0; i < cols; i++) res += `<td>${td}</td>`;
      return res + `</tr>`;
    };

    // --- Traffic Analyzer Filters Modal ---
    function openQtFiltersModal() {
      // Just visually open it, values remain in the inputs
      document.getElementById('modal-qt-filters').classList.add('show');
    }

    function applyQtFilters() {
      closeModal('modal-qt-filters');
      runTrafficAnalyzer(); // Automatically execute query with applied filters
    }

    // --- Traffic Analyzer Endpoint ---
    async function runTrafficAnalyzer() {
      const pdRadio = document.querySelector('input[name="qt-pd-radio"]:checked');
      const pd = pdRadio ? pdRadio.value : "-1";
      const sort = document.getElementById('qt-sort').value;
      const search = document.getElementById('qt-search').value;
      const mins = parseInt(document.getElementById('qt-mins').value);

      const srcStr = document.getElementById('qt-src').value.trim();
      const dstStr = document.getElementById('qt-dst').value.trim();
      const exSrcStr = document.getElementById('qt-exsrc').value.trim();
      const exDstStr = document.getElementById('qt-exdst').value.trim();
      const expStr = document.getElementById('qt-expt').value.trim();
      const port = document.getElementById('qt-port').value.trim();
      const proto = document.getElementById('qt-proto').value;

      const bd = document.getElementById('qt-body');
      bd.innerHTML = renderSkeletonRow(8);
      document.getElementById('qt-chkall').checked = false;
      updateBulkBar();

      try {
        let payload = { mins, sort_by: sort, search: search, policy_decision: pd };

        if (srcStr) {
          if (srcStr.includes('=')) payload.src_label = srcStr;
          else payload.src_ip_in = srcStr;
        }
        if (dstStr) {
          if (dstStr.includes('=')) payload.dst_label = dstStr;
          else payload.dst_ip_in = dstStr;
        }
        if (exSrcStr) {
          if (exSrcStr.includes('=')) payload.ex_src_label = exSrcStr;
          else payload.ex_src_ip = exSrcStr;
        }
        if (exDstStr) {
          if (exDstStr.includes('=')) payload.ex_dst_label = exDstStr;
          else payload.ex_dst_ip = exDstStr;
        }
        if (port) payload.port = port;
        if (expStr) payload.ex_port = expStr;
        if (proto) payload.proto = proto;

        const r = await post('/api/quarantine/search', payload);

        if (!r.ok || r.error) throw new Error(r.error || 'Server error');

        // --- Pagination Logic ---
        _qt_data = r.data || [];
        _qt_page = 1;
        renderQtPage();

      } catch (err) {
        bd.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--danger);">Error: ${escapeHtml(err.message)}</td></tr>`;
      }
    }

    let _qt_data = [];
    let _qt_page = 1;

    function renderQtPage() {
      const bd = document.getElementById('qt-body');
      const pageSize = parseInt(document.getElementById('qt-page-size').value);
      const total = _qt_data.length;
      const start = (_qt_page - 1) * pageSize;
      const end = Math.min(start + pageSize, total);
      const pageData = _qt_data.slice(start, end);

      const pagBar = document.getElementById('qt-pagination');
      const totalLabel = document.getElementById('qt-total-count');
      const pageNumDisplay = document.getElementById('qt-page-num');

      if (total > 0) {
        pagBar.style.display = 'flex';
        totalLabel.textContent = (_translations['gui_total_found'] || 'Total {count} records').replace('{count}', total);
        pageNumDisplay.textContent = _qt_page;
      } else {
        pagBar.style.display = 'none';
        bd.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--dim);">${_translations['gui_no_traffic'] || 'No anomalous traffic found matching criteria.'}</td></tr>`;
        return;
      }

      let html = '';
      pageData.forEach((item, idx) => {
        let shref = item.source.href;
        let dhref = item.destination.href;
        let targetHref = shref || dhref || "";
        let chkBox = targetHref ? `<input type="checkbox" class="qt-chk" value="${targetHref}">` : `<span style="color:var(--dim);font-size:10px;">${_translations['gui_management_unmanaged'] || 'Unmanaged'}</span>`;

        const formatActor = (actor) => {
          let procStr = '';
          if (actor.process || actor.user) {
            let p = actor.process ? `<span style="color:var(--accent); font-weight:bold;"><i class="fas fa-microchip"></i> Proc: ${escapeHtml(actor.process)}</span>` : '';
            let u = actor.user ? `<span style="color:var(--accent2);"><i class="fas fa-user"></i> User: ${escapeHtml(actor.user)}</span>` : '';
            let sep = (p && u) ? '<br>' : '';
            procStr = `<div style="font-size:10px; margin-top:4px;">${p}${sep}${u}</div>`;
          }
          return `<strong style="font-size:11px;">${escapeHtml(actor.name)}</strong><br><small style="color:var(--dim);">${escapeHtml(actor.ip)}</small>${procStr}<div style="margin-top:2px;">${renderLabelsHtml(actor.labels)}</div>`;
        };

        const sort = document.getElementById('qt-sort').value;
        let val_str = "";
        if (sort === "bandwidth") val_str = item.formatted_bandwidth;
        else if (sort === "volume") val_str = item.formatted_volume;
        else val_str = item.formatted_connections + " " + (_translations['gui_flows'] || "flows");

        let svc_str = "";
        let name_part = item.service.name ? item.service.name + " " : "";
        if (item.service.port !== "All") svc_str = `${name_part}${item.service.proto}/${item.service.port}`;
        else svc_str = name_part ? `${name_part}${_translations['gui_all_services'] || "All Services"}` : (_translations['gui_all_services'] || "All Services");

        if (svc_str.length > 25) {
          let arr = svc_str.split(',').map(s => s.trim());
          let encJson = encodeURIComponent(JSON.stringify(arr));
          svc_str = `<span onclick="showCellPopover(event, 'SVC', JSON.parse(decodeURIComponent('${encJson}')))" style="cursor:pointer; border-bottom:1px dotted var(--dim); color:var(--accent);">${escapeHtml(svc_str.substring(0, 23))}...</span>`;
        } else {
          svc_str = escapeHtml(svc_str);
        }

        const rawPd = item.policy_decision || '';
        let pdBadge = '';
        const pd_blocked = _translations['gui_pd_blocked'] || 'Blocked';
        const pd_potential = _translations['gui_pd_potential'] || 'Potential';
        const pd_allowed = _translations['gui_pd_allowed'] || 'Allowed';

        if (rawPd === 'blocked') pdBadge = `<span style="background:var(--danger);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">${pd_blocked}</span>`;
        else if (rawPd === 'potentially_blocked') pdBadge = `<span style="background:var(--warn);color:#000;padding:2px 6px;border-radius:4px;font-size:10px;">${pd_potential}</span>`;
        else pdBadge = `<span style="background:var(--success);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">${pd_allowed}</span>`;

        let isoBtn = '';
        if (shref && dhref) isoBtn = `<button class="btn btn-secondary btn-sm" onclick="openQuarantineModal('${shref}', false, '${dhref}')">Isolate</button>`;
        else if (shref || dhref) isoBtn = `<button class="btn btn-secondary btn-sm" onclick="openQuarantineModal('${shref || dhref}')">Isolate</button>`;

        let f_seen = item.timestamp_range ? item.timestamp_range.first_detected || "" : "";
        let l_seen = item.timestamp_range ? item.timestamp_range.last_detected || "" : "";
        if (f_seen) f_seen = formatDateZ(f_seen);
        if (l_seen) l_seen = formatDateZ(l_seen);

        html += `<tr>
              <td style="text-align:center;">${chkBox}</td>
              <td><div style="font-weight:bold;color:var(--accent2);">${val_str}</div></td>
              <td style="font-size:10px;"><div style="color:var(--dim);">F: ${f_seen}</div><div style="color:var(--dim);">L: ${l_seen}</div></td>
              <td>${formatActor(item.source)}</td>
              <td>${formatActor(item.destination)}</td>
              <td>${svc_str}</td>
              <td>${pdBadge}</td>
              <td>${isoBtn}</td>
            </tr>`;
      });
      bd.innerHTML = html;
      initTableResizers();
    }

    function qtNextPage() {
      const pageSize = parseInt(document.getElementById('qt-page-size').value);
      if (_qt_page * pageSize < _qt_data.length) {
        _qt_page++;
        renderQtPage();
      }
    }

    function qtPrevPage() {
      if (_qt_page > 1) {
        _qt_page--;
        renderQtPage();
      }
    }

    function openQtGuideModal() {
      document.getElementById('modal-qt-guide').classList.add('show');
    }

    // --- Workload Search Endpoint ---
    async function runWorkloadSearch() {
      const name = document.getElementById('qw-name').value;
      const ip = document.getElementById('qw-ip').value;
      const host = document.getElementById('qw-host').value;

      const bd = document.getElementById('qw-body');
      bd.innerHTML = renderSkeletonRow(6);
      document.getElementById('qw-chkall').checked = false;
      updateBulkBar();

      try {
        const payload = { name, ip, hostname: host };
        const qp = new URLSearchParams(payload).toString();
        const r = await fetch('/api/workloads?' + qp).then(res => res.json());

        if (!r.ok && r.error) throw new Error(r.error);
        _qw_data = r.data || [];
        _qw_page = 1;
        renderQwPage();

      } catch (err) {
        bd.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--danger);">Error: ${escapeHtml(err.message)}</td></tr>`;
      }
    }

    let _qw_data = [];
    let _qw_page = 1;

    function renderQwPage() {
      const bd = document.getElementById('qw-body');
      const pageSize = parseInt(document.getElementById('qw-page-size').value);
      const total = _qw_data.length;
      const start = (_qw_page - 1) * pageSize;
      const end = Math.min(start + pageSize, total);
      const pageData = _qw_data.slice(start, end);

      const pagBar = document.getElementById('qw-pagination');
      const totalLabel = document.getElementById('qw-total-count');
      const pageNumDisplay = document.getElementById('qw-page-num');

      if (total > 0) {
        pagBar.style.display = 'flex';
        totalLabel.textContent = (_translations['gui_total_found_ws'] || 'Total {count} workloads').replace('{count}', total);
        pageNumDisplay.textContent = _qw_page;
      } else {
        pagBar.style.display = 'none';
        bd.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--dim);" data-i18n="gui_ws_empty">${_translations['gui_ws_empty'] || 'Search by IP or Name to find workloads in the PCE.'}</td></tr>`;
        return;
      }

      let html = '';
      pageData.forEach((w) => {
        const href = w.href;
        const isOnline = w.online === true;
        const statusText = isOnline ? (_translations['gui_status_online'] || 'Online') : (_translations['gui_status_offline'] || 'Offline');
        const statusDot = `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${isOnline ? 'var(--success)' : 'var(--warn)'};margin-right:6px;" title="${statusText}"></span>`;

        let hasQuarantine = false;
        if (w.labels) {
          w.labels.forEach(l => {
            if (l.key === 'Quarantine') hasQuarantine = true;
          });
        }
        let labelsHtml = renderLabelsHtml(w.labels);

        // Find IPv4 default interface IP
        let ipStr = "";
        if (w.interfaces && w.interfaces.length > 0) {
          let intf = w.interfaces.find(i => i.address && i.address.includes('.'));
          if (!intf) intf = w.interfaces.find(i => i.address) || w.interfaces[0];
          ipStr = `${escapeHtml(intf.address)} <span style="font-size:10px;color:var(--dim)">(${escapeHtml(intf.name)})</span>`;
        }

        const mgmtText = w.managed ? (_translations['gui_management_managed'] || 'Managed') : (_translations['gui_management_unmanaged'] || 'Unmanaged');

        html += `<tr>
              <td style="text-align:center;"><input type="checkbox" class="qw-chk" value="${href}"></td>
              <td>
                <div style="display:flex;align-items:center;">
                  ${statusDot} <strong style="font-size:0.95rem;">${escapeHtml(w.name || w.hostname)}</strong>
                </div>
                <div style="font-size:10px;color:var(--dim);margin-top:2px;margin-left:14px;">${escapeHtml(w.hostname)}</div>
              </td>
              <td><span style="font-size:11px; color:${w.managed ? 'var(--success)' : 'var(--dim)'}">${mgmtText}</span></td>
              <td>${ipStr}</td>
              <td style="font-size:11px;">${labelsHtml || '<span style="color:var(--dim);font-size:10px;">No Labels</span>'}</td>
              <td>
                <button class="btn btn-secondary btn-sm" onclick="openQuarantineModal('${href}')">Isolate</button>
                ${hasQuarantine ? `<span style="font-size:10px;color:var(--danger);font-weight:bold;margin-left:8px;">Isolated</span>` : ''}
              </td>
            </tr>`;
      });
      bd.innerHTML = html;
      initTableResizers();
    }

    function qwNextPage() {
      const pageSize = parseInt(document.getElementById('qw-page-size').value);
      if (_qw_page * pageSize < _qw_data.length) {
        _qw_page++;
        renderQwPage();
      }
    }

    function qwPrevPage() {
      if (_qw_page > 1) {
        _qw_page--;
        renderQwPage();
      }
    }

    // Listen to Radio changes if isolating
    document.querySelectorAll('input[name="q-dir"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        if (window._qTempHrefs) {
          let tgt = e.target.value === 'source' ? window._qTempHrefs.source : window._qTempHrefs.destination;
          document.getElementById('q-target-hrefs').value = JSON.stringify([tgt]);
        }
      });
    });

    // Background initialization
    setTimeout(() => {
      // Attempt to init quarantine labels so they are ready on PCE
      fetch('/api/init_quarantine', { method: 'POST' }).catch(() => { });
    }, 2000);

    loadDashboard();
    testConn();
  </script>
</body>

</html>