<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Illumio PCE Monitor</title>
<style>
:root {
  --bg: #1a2c32; --bg2: #24393f; --bg3: #2d454c;
  --fg: #F5F5F5; --dim: #989A9B; --accent: #FF5500;
  --accent2: #FFA22F; --success: #299b65; --warn: #FFB74A;
  --danger: #f43f51; --border: #325158;
  --radius: 10px; --shadow: 0 4px 24px rgba(0,0,0,.4);
}
[data-theme="light"] {
  --bg: #F5F5F5; --bg2: #FFFFFF; --bg3: #EAEBEB;
  --fg: #313638; --dim: #6F7274; --accent: #FF5500;
  --accent2: #F97607; --success: #166644; --warn: #FFA22F;
  --danger: #be122f; --border: #D6D7D7;
  --shadow: 0 2px 10px rgba(0,0,0,.05);
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI',system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--fg); min-height:100vh; }
a { color:var(--accent2); }

/* Header */
.header { background:linear-gradient(135deg,var(--bg2),var(--bg3)); padding:16px 28px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--border); }
.header h1 { font-size:1.3rem; font-weight:700; background:linear-gradient(135deg,var(--accent2),var(--success)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.header .meta { color:var(--dim); font-size:.85rem; }

/* Tabs */
.tabs { display:flex; gap:2px; background:var(--bg2); padding:6px 20px 0; border-bottom:1px solid var(--border); }
.tab { padding:10px 22px; cursor:pointer; border-radius:var(--radius) var(--radius) 0 0; color:var(--dim); font-weight:600; font-size:.9rem; transition:.2s; border:1px solid transparent; border-bottom:none; }
.tab:hover { color:var(--fg); background:var(--bg3); }
.tab.active { color:var(--accent2); background:var(--bg); border-color:var(--border); }

/* Panel */
.panel { display:none; padding:24px; animation:fadeIn .2s; }
.panel.active { display:block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

/* Cards */
.cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:14px; margin-bottom:20px; }
.card { background:var(--bg2); border:1px solid var(--border); border-radius:var(--radius); padding:18px; text-align:center; }
.card .label { color:var(--dim); font-size:.8rem; margin-bottom:6px; }
.card .value { font-size:1.8rem; font-weight:700; color:var(--accent2); }
.card .value.ok { color:var(--success); }
.card .value.err { color:var(--danger); }

/* Buttons */
.btn { display:inline-flex; align-items:center; gap:6px; padding:9px 18px; border:none; border-radius:8px; font-size:.88rem; font-weight:600; cursor:pointer; transition:.15s; }
.btn-primary { background:var(--accent); color:#fff; }
.btn-primary:hover { background:var(--accent2); color:#1a2c32; }
.btn-success { background:#166644; color:#fff; }
.btn-success:hover { background:var(--success); color:#fff; }
.btn-danger { background:#be122f; color:#fff; }
.btn-danger:hover { background:var(--danger); }
.btn-warn { background:#d97706; color:#fff; }
.btn-warn:hover { background:var(--warn); color:#1a2c32; }
.btn-sm { padding:6px 12px; font-size:.8rem; }
.btn:disabled { opacity:.5; cursor:not-allowed; }

/* Forms */
.form-group { margin-bottom:12px; }
.form-group label { display:block; color:var(--dim); font-size:.82rem; margin-bottom:4px; font-weight:600; }
.form-group input, .form-group select { width:100%; background:var(--bg); border:1px solid var(--border); color:var(--fg); padding:8px 12px; border-radius:6px; font-size:.9rem; }
.form-group input:focus, .form-group select:focus { outline:none; border-color:var(--accent); }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.form-row-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }

/* Fieldset */
fieldset { border:1px solid var(--border); border-radius:var(--radius); padding:16px; margin-bottom:16px; }
legend { color:var(--accent2); font-weight:700; font-size:.9rem; padding:0 8px; }

/* Table */
.rule-table { width:100%; border-collapse:collapse; margin-top:12px; table-layout:fixed; }
.rule-table th, .rule-table td { text-align:left; padding:10px 14px; border-bottom:1px solid var(--border); font-size:.88rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.rule-table th { color:var(--dim); font-weight:600; background:var(--bg2); position:relative; }
.rule-table tr:hover td { background:var(--bg3); }
.resizer { position:absolute; top:25%; right:0; width:4px; height:50%; cursor:col-resize; user-select:none; z-index:2; transition: background 0.2s; background:var(--border); border-radius:2px; }
.resizer:hover, .resizer:active { background:var(--accent); width:6px; }

/* Log */
.log-box { background:var(--bg2); border:1px solid var(--border); border-radius:var(--radius); padding:14px; font-family:'Cascadia Code','Fira Code',monospace; font-size:.82rem; color:var(--fg); max-height:360px; overflow-y:auto; white-space:pre-wrap; word-break:break-all; line-height:1.6; }

/* Actions */
.action-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-bottom:20px; }
.action-card { background:var(--bg2); border:1px solid var(--border); border-radius:var(--radius); padding:18px; display:flex; flex-direction:column; gap:10px; }
.action-card h3 { font-size:.95rem; color:var(--accent2); }
.action-card p { font-size:.8rem; color:var(--dim); flex:1; }

/* Modal */
.modal-bg { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100; align-items:center; justify-content:center; }
.modal-bg.show { display:flex; }
.modal { background:var(--bg); border:1px solid var(--border); border-radius:14px; padding:24px; width:560px; max-width:95vw; max-height:85vh; overflow-y:auto; box-shadow:var(--shadow); }
.modal h2 { font-size:1.1rem; color:var(--accent2); margin-bottom:16px; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }

/* Toolbar */
.toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:14px; align-items:center; }
.toolbar .spacer { flex:1; }
.badge { background:var(--accent); color:#fff; padding:2px 10px; border-radius:20px; font-size:.78rem; font-weight:700; }

/* Radio group */
.radio-group { display:flex; gap:12px; flex-wrap:wrap; }
.radio-group label { display:flex; align-items:center; gap:4px; color:var(--fg); font-size:.88rem; cursor:pointer; }
.radio-group input[type=radio] { accent-color:var(--accent); }

/* Checkbox */
.chk label { display:flex; align-items:center; gap:6px; color:var(--fg); font-size:.88rem; cursor:pointer; }
.chk input[type=checkbox] { accent-color:var(--accent); }

/* Toast */
.toast { position:fixed; bottom:24px; right:24px; background:var(--success); color:#000; padding:12px 20px; border-radius:8px; font-weight:600; font-size:.88rem; z-index:200; opacity:0; transition:.3s; pointer-events:none; }
.toast.show { opacity:1; }
.toast.err { background:var(--danger); color:#fff; }
</style>
</head>
<body>

<div class="header">
  <h1 data-i18n="gui_title">‚óÜ Illumio PCE Monitor</h1>
  <div style="display:flex;align-items:center;gap:14px"><span class="meta" id="hdr-meta">Loading...</span><button class="btn btn-danger btn-sm" onclick="stopGui()" title="Stop Web GUI" data-i18n="gui_stop">‚èπ Stop</button></div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('dashboard')" data-i18n="gui_tab_dashboard">Dashboard</div>
  <div class="tab" onclick="switchTab('rules')" data-i18n="gui_tab_rules">Rules</div>
  <div class="tab" onclick="switchTab('settings')" data-i18n="gui_tab_settings">Settings</div>
  <div class="tab" onclick="switchTab('actions')" data-i18n="gui_tab_actions">Actions</div>
</div>

<!-- ‚ïê‚ïê‚ïê Dashboard ‚ïê‚ïê‚ïê -->
<div class="panel active" id="p-dashboard">
  <div class="cards">
    <div class="card"><div class="label" data-i18n="gui_active_rules">Active Rules</div><div class="value" id="d-rules">‚Äî</div></div>
    <div class="card"><div class="label" data-i18n="gui_health_check">Health Check</div><div class="value" id="d-health">‚Äî</div></div>
    <div class="card"><div class="label" data-i18n="gui_language">Language</div><div class="value" id="d-lang">‚Äî</div></div>
  </div>
  <fieldset id="cd-field" style="display:none;margin-bottom:14px;border:none;padding:0;">
    <div id="cd-list" class="cards" style="margin-bottom:0;"></div>
  </fieldset>
  <fieldset style="margin-bottom:14px;">
    <legend><span data-i18n="gui_top10_title" style="font-size:1.05rem;">Top 10 Query Report</span></legend>
    <div style="display:flex;gap:8px;margin-bottom:14px;align-items:center;">
       <label data-i18n="gui_window_min" style="font-weight:600;color:var(--dim);font-size:0.85rem;">Window (min):</label>
       <input id="d-global-min" type="number" value="30" style="width:80px;background:var(--bg);border:1px solid var(--border);color:var(--fg);padding:4px 8px;border-radius:4px;">
       <span style="flex:1"></span>
       <button class="btn btn-warn btn-sm" onclick="openQueryModal()" data-i18n="gui_add_query_widget">‚ûï Add Query Widget</button>
       <button class="btn btn-primary btn-sm" onclick="runAllQueries()" data-i18n="gui_run_all_queries">‚ñ∂ Run All</button>
    </div>
    <div id="d-queries-container" style="display:flex;flex-direction:column;gap:16px;">
        <!-- Query Profile Tables generated dynamically -->
    </div>
  </fieldset>
</div>

<!-- ‚ïê‚ïê‚ïê Rules ‚ïê‚ïê‚ïê -->
<div class="panel" id="p-rules">
  <div class="toolbar">
    <span style="font-size:1.1rem;font-weight:700;color:var(--accent2)" data-i18n="gui_tab_rules">Rules</span>
    <span class="badge" id="r-badge">0</span>
    <button class="btn btn-sm" style="margin-left:8px;background:var(--dim);color:#fff" onclick="openModal('m-help')" data-i18n="gui_param_guide">üìñ Parameter Guide</button>
    <div class="spacer"></div>
    <button class="btn btn-warn btn-sm" onclick="openModal('m-event')" data-i18n="gui_add_event">üìã + Event</button>
    <button class="btn btn-warn btn-sm" onclick="openModal('m-traffic')" data-i18n="gui_add_traffic">üö¶ + Traffic</button>
    <button class="btn btn-warn btn-sm" onclick="openModal('m-bw')" data-i18n="gui_add_bw">üìä + BW/Vol</button>
    <button class="btn btn-danger btn-sm" onclick="deleteSelected()" data-i18n="gui_delete">üóë Delete</button>
  </div>
  <table class="rule-table">
    <thead><tr><th style="width:30px"><input type="checkbox" id="r-chkall" onchange="toggleAll(this)"></th><th data-i18n="gui_col_type">Type</th><th data-i18n="gui_col_name">Name</th><th style="width:110px" data-i18n="gui_col_status">Status</th><th data-i18n="gui_col_condition">Condition</th><th data-i18n="gui_col_filters">Filters</th><th style="width:50px" data-i18n="gui_col_edit">Edit</th></tr></thead>
    <tbody id="r-body"></tbody>
  </table>
</div>

<!-- ‚ïê‚ïê‚ïê Settings ‚ïê‚ïê‚ïê -->
<div class="panel" id="p-settings">
  <div class="cards" style="margin-bottom:14px;">
    <div class="card"><div class="label" data-i18n="gui_api_status">API Status</div><div class="value" id="d-api">‚Äî</div></div>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:14px;">
    <button class="btn btn-primary" onclick="testConn()" data-i18n="gui_test_conn">üîó Test Connection</button>
  </div>
  <div class="log-box" id="s-log" style="height:80px;margin-bottom:14px;font-size:0.85rem;">[Ready]</div>
  <div id="s-form"></div>
  <div style="text-align:right;margin-top:16px;">
    <button class="btn btn-success" onclick="saveSettings()" data-i18n="gui_save_all">üíæ Save All Settings</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê Actions ‚ïê‚ïê‚ïê -->
<div class="panel" id="p-actions">
  <div class="action-grid">
    <div class="action-card"><h3 data-i18n="gui_run_once">‚ñ∂ Run Monitor Once</h3><p data-i18n="gui_run_once_desc">Execute full cycle: Health ‚Üí Fetch ‚Üí Analyze ‚Üí Alert</p><button class="btn btn-primary" onclick="runAction('run')" data-i18n="gui_run_btn">Run</button></div>
    <div class="action-card"><h3 data-i18n="gui_debug_mode">üîç Debug Mode</h3><p data-i18n="gui_debug_desc">Sandbox mode ‚Äî no alerts, no state updates</p>
      <div class="form-row" style="margin-bottom:8px;">
        <div class="form-group"><label data-i18n="gui_window_min">Window (min)</label><input id="a-debug-mins" value="30"></div>
        <div class="form-group"><label data-i18n="gui_policy_dec">Policy Dec.</label><select id="a-debug-pd"><option value="1" data-i18n="gui_pd_blocked">Blocked</option><option value="2" data-i18n="gui_pd_allowed">Allowed</option><option value="3" data-i18n="gui_pd_all" selected>All</option></select></div>
      </div>
      <button class="btn btn-primary" onclick="runDebug()" data-i18n="gui_run_debug">Run Debug</button>
    </div>
    <div class="action-card"><h3 data-i18n="gui_test_alert">üìß Send Test Alert</h3><p data-i18n="gui_test_alert_desc">Verify Email / LINE / Webhook delivery</p><button class="btn btn-primary" onclick="runAction('test-alert')" data-i18n="gui_send">Send</button></div>
    <div class="action-card"><h3 data-i18n="gui_best_practices">üìã Load Best Practices</h3><p data-i18n="gui_best_practices_desc">Replace ALL existing rules with recommended defaults</p><button class="btn btn-danger" onclick="confirmBestPractices()" data-i18n="gui_load">Load</button></div>
  </div>
  <h3 style="color:var(--accent2);margin-bottom:8px;" data-i18n="gui_output">Output</h3>
  <div class="log-box" id="a-log"></div>
</div>

<!-- ‚ïê‚ïê‚ïê Modals ‚ïê‚ïê‚ïê -->
<!-- Dashboard Query Profile Modal -->
<div class="modal-bg" id="m-query"><div class="modal">
  <h2><span data-i18n="gui_add_query_widget" id="mq-title">Add Query Widget</span></h2>
  <input type="hidden" id="dq-idx" value="-1">
  <div class="form-row"><div class="form-group"><label data-i18n="gui_query_widget_name">Widget Name</label><input id="dq-name" placeholder="E.g. Core Services Top Clients"></div><div class="form-group"><label data-i18n="gui_rank_by">Rank By</label><select id="dq-rank"><option value="count" data-i18n="gui_rank_count">Connection Count</option><option value="volume" data-i18n="gui_rank_volume">Total Volume (MB)</option><option value="bandwidth" data-i18n="gui_rank_bw">Max Bandwidth (Mbps)</option></select></div></div>
  <fieldset><legend data-i18n="gui_policy_dec">Policy Decision</legend><div class="radio-group" id="dq-pd-group">
    <label><input type="radio" name="dq-pd" value="3" checked> <span data-i18n="gui_pd_all">All</span></label>
    <label><input type="radio" name="dq-pd" value="2"> <span data-i18n="gui_pd_blocked">Blocked</span></label>
    <label><input type="radio" name="dq-pd" value="1"> <span data-i18n="gui_pd_potential">Potential</span></label>
    <label><input type="radio" name="dq-pd" value="0"> <span data-i18n="gui_pd_allowed">Allowed</span></label>
  </div></fieldset>
  <fieldset><legend data-i18n="gui_col_filters">Filters</legend>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_port">Port</label><input id="dq-port" placeholder="e.g. 80, 443"></div><div class="form-group"><label data-i18n="gui_protocol">Protocol</label><select id="dq-proto"><option value="" data-i18n="gui_both">Both</option><option value="6" data-i18n="gui_tcp">TCP</option><option value="17" data-i18n="gui_udp">UDP</option></select></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_source">Source (Label/IP)</label><input id="dq-src" placeholder="e.g. role=Web, 10.0.0.0/8, 192.168.1.1"></div><div class="form-group"><label data-i18n="gui_dest">Destination (Label/IP)</label><input id="dq-dst" placeholder="e.g. app=DB, 10.1.1.5"></div></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_excludes">Excludes (Optional)</legend>
    <div class="form-row-3"><div class="form-group"><label data-i18n="gui_ex_port">Exclude Port</label><input id="dq-expt" placeholder="e.g. 22"></div><div class="form-group"><label data-i18n="gui_ex_src">Exclude Source</label><input id="dq-exsrc" placeholder="e.g. env=Kube, 10.9.9.9"></div><div class="form-group"><label data-i18n="gui_ex_dest">Exclude Destination</label><input id="dq-exdst" placeholder="e.g. 8.8.8.8"></div></div>
  </fieldset>
  <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-query')" data-i18n="gui_cancel">Cancel</button><button class="btn btn-success" onclick="saveDashboardQuery()" data-i18n="gui_save">üíæ Save</button></div>
</div></div>

<!-- Event -->
<div class="modal-bg" id="m-event"><div class="modal">
  <h2><span data-i18n="gui_add_event_rule" id="me-title">Add Event Rule</span></h2>
  <div class="form-group"><label data-i18n="gui_category">Category</label><select id="ev-cat" onchange="populateEvents()"><option value="" data-i18n="gui_select">Select...</option></select></div>
  <div class="form-group"><label data-i18n="gui_event_type">Event Type</label><select id="ev-type"><option value="" data-i18n="gui_select_first">Select category first</option></select></div>
  <fieldset><legend data-i18n="gui_threshold">Threshold</legend>
    <div class="form-group"><label data-i18n="gui_type">Type</label><div class="radio-group"><label><input type="radio" name="ev-tt" value="immediate" checked> <span data-i18n="gui_tt_immediate">Immediate</span></label><label><input type="radio" name="ev-tt" value="count"> <span data-i18n="gui_tt_count">Cumulative</span></label></div></div>
    <div class="form-row-3">
      <div class="form-group"><label data-i18n="gui_count">Count</label><input id="ev-cnt" type="number" value="5"></div>
      <div class="form-group"><label data-i18n="gui_window_min">Window (min)</label><input id="ev-win" type="number" value="10"></div>
      <div class="form-group"><label data-i18n="gui_cooldown">Cooldown (min)</label><input id="ev-cd" type="number" value="10"></div>
    </div>
  </fieldset>
  <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-event')" data-i18n="gui_cancel">Cancel</button><button class="btn btn-success" onclick="saveEvent()" data-i18n="gui_save">üíæ Save</button></div>
</div></div>

<!-- Traffic -->
<div class="modal-bg" id="m-traffic"><div class="modal">
  <h2><span data-i18n="gui_add_traffic_rule" id="mt-title">Add Traffic Rule</span></h2>
  <div class="form-group"><label data-i18n="gui_rule_name">Rule Name</label><input id="tr-name"></div>
  <fieldset><legend data-i18n="gui_policy_dec">Policy Decision</legend><div class="radio-group">
    <label><input type="radio" name="tr-pd" value="2" checked> <span data-i18n="gui_pd_blocked">Blocked</span></label>
    <label><input type="radio" name="tr-pd" value="1"> <span data-i18n="gui_pd_potential">Potential</span></label>
    <label><input type="radio" name="tr-pd" value="0"> <span data-i18n="gui_pd_allowed">Allowed</span></label>
    <label><input type="radio" name="tr-pd" value="-1"> <span data-i18n="gui_pd_all">All</span></label>
  </div></fieldset>
  <fieldset><legend data-i18n="gui_col_filters">Filters</legend>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_port">Port</label><input id="tr-port" placeholder="e.g. 80, 443"></div><div class="form-group"><label data-i18n="gui_protocol">Protocol</label><select id="tr-proto"><option value="" data-i18n="gui_both">Both</option><option value="6" data-i18n="gui_tcp">TCP</option><option value="17" data-i18n="gui_udp">UDP</option></select></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_source">Source (Label/IP)</label><input id="tr-src" placeholder="e.g. role=Web, 10.0.0.0/8, 192.168.1.1"></div><div class="form-group"><label data-i18n="gui_dest">Destination (Label/IP)</label><input id="tr-dst" placeholder="e.g. app=DB, 10.1.1.5"></div></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_excludes">Excludes (Optional)</legend>
    <div class="form-row-3"><div class="form-group"><label data-i18n="gui_ex_port">Exclude Port</label><input id="tr-expt" placeholder="e.g. 22"></div><div class="form-group"><label data-i18n="gui_ex_src">Exclude Source</label><input id="tr-exsrc" placeholder="e.g. env=Kube, 10.9.9.9"></div><div class="form-group"><label data-i18n="gui_ex_dest">Exclude Destination</label><input id="tr-exdst" placeholder="e.g. 8.8.8.8"></div></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_threshold">Threshold</legend>
    <div class="form-row-3"><div class="form-group"><label data-i18n="gui_count">Count</label><input id="tr-cnt" type="number" value="10"></div><div class="form-group"><label data-i18n="gui_window_min">Window (min)</label><input id="tr-win" type="number" value="10"></div><div class="form-group"><label data-i18n="gui_cooldown">Cooldown (min)</label><input id="tr-cd" type="number" value="10"></div></div>
  </fieldset>
  <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-traffic')" data-i18n="gui_cancel">Cancel</button><button class="btn btn-success" onclick="saveTraffic()" data-i18n="gui_save">üíæ Save</button></div>
</div></div>

<!-- BW/Volume -->
<div class="modal-bg" id="m-bw"><div class="modal">
  <h2><span data-i18n="gui_add_bw_rule" id="mb-title">Add Bandwidth / Volume Rule</span></h2>
  <div class="form-group"><label data-i18n="gui_rule_name">Rule Name</label><input id="bw-name"></div>
  <fieldset><legend data-i18n="gui_metric_type">Metric Type</legend><div class="radio-group">
    <label><input type="radio" name="bw-mt" value="bandwidth" checked> <span data-i18n="gui_mt_bw">Bandwidth (Mbps, Max)</span></label>
    <label><input type="radio" name="bw-mt" value="volume"> <span data-i18n="gui_mt_vol">Volume (MB, Sum)</span></label>
  </div></fieldset>
  <fieldset><legend data-i18n="gui_policy_dec">Policy Decision</legend><div class="radio-group">
    <label><input type="radio" name="bw-pd" value="2"> <span data-i18n="gui_pd_blocked">Blocked</span></label>
    <label><input type="radio" name="bw-pd" value="1"> <span data-i18n="gui_pd_potential">Potential</span></label>
    <label><input type="radio" name="bw-pd" value="0"> <span data-i18n="gui_pd_allowed">Allowed</span></label>
    <label><input type="radio" name="bw-pd" value="-1" checked> <span data-i18n="gui_pd_all">All</span></label>
  </div></fieldset>
  <fieldset><legend data-i18n="gui_col_filters">Filters</legend>
    <div class="form-row-3"><div class="form-group"><label data-i18n="gui_port">Port</label><input id="bw-port" placeholder="e.g. 443"></div><div class="form-group"><label data-i18n="gui_source">Source (Label/IP)</label><input id="bw-src" placeholder="e.g. role=Web, 10.0.0.0/8"></div><div class="form-group"><label data-i18n="gui_dest">Destination (Label/IP)</label><input id="bw-dst" placeholder="e.g. app=DB, 10.1.1.5"></div></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_excludes">Excludes (Optional)</legend>
    <div class="form-row-3"><div class="form-group"><label data-i18n="gui_ex_port">Exclude Port</label><input id="bw-expt" placeholder="e.g. 22"></div><div class="form-group"><label data-i18n="gui_ex_src">Exclude Source</label><input id="bw-exsrc" placeholder="e.g. env=Kube, 10.9.9.9"></div><div class="form-group"><label data-i18n="gui_ex_dest">Exclude Destination</label><input id="bw-exdst" placeholder="e.g. 8.8.8.8"></div></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_threshold">Threshold</legend>
    <div class="form-row-3"><div class="form-group"><label data-i18n="gui_value">Value</label><input id="bw-val" type="number" value="100"></div><div class="form-group"><label data-i18n="gui_window_min">Window (min)</label><input id="bw-win" type="number" value="10"></div><div class="form-group"><label data-i18n="gui_cooldown">Cooldown (min)</label><input id="bw-cd" type="number" value="30"></div></div>
  </fieldset>
  <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-bw')" data-i18n="gui_cancel">Cancel</button><button class="btn btn-success" onclick="saveBW()" data-i18n="gui_save">üíæ Save</button></div>
</div></div>

<!-- Help / Parameter Guide -->
<div class="modal-bg" id="m-help"><div class="modal" style="max-width:600px;">
  <h2>üìñ Parameter Guide (API 25.2)</h2>
  <div style="color:var(--dim);line-height:1.6;font-size:0.95rem;">
    <p>Illumio PCE Monitor leverages the standard Illumio Traffic Analysis REST API parameters.</p>
    <h3 style="color:#fff;margin-top:12px">Filters & Excludes</h3>
    <ul style="padding-left:20px;margin-bottom:12px">
      <li><strong>Label format:</strong> <code>key=value</code> (e.g., <code>role=Web</code>, <code>env=Production</code>, <code>app=Database</code>). Must exactly match the PCE label keys and values.</li>
      <li><strong>IP List/CIDR format:</strong> Standard CIDR notation (e.g., <code>10.0.0.0/8</code>) or exact IPs (e.g., <code>192.168.1.50</code>).</li>
      <li><strong>Port format:</strong> Integer port numbers (e.g., <code>80</code>, <code>443</code>, <code>3306</code>).</li>
    </ul>

    <h3 style="color:#fff;margin-top:12px">Policy Decisions</h3>
    <ul style="padding-left:20px;margin-bottom:12px">
      <li><strong>Blocked:</strong> Traffic explicitly dropped by policy.</li>
      <li><strong>Potential:</strong> Traffic that <em>would</em> be blocked if the workload were placed into Enforced mode.</li>
      <li><strong>Allowed:</strong> Traffic permitted by policy.</li>
    </ul>
  </div>
  <div class="modal-actions"><button class="btn btn-primary" onclick="closeModal('m-help')">Close window</button></div>
</div></div>

<div class="toast" id="toast"></div>

<script>
/* ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const $=s=>document.getElementById(s);
const api=async(url,opt)=>{const r=await fetch(url,opt);return r.json()};
const post=(url,body)=>api(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
const put=(url,body)=>api(url,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
const del=url=>api(url,{method:'DELETE'});
const rv=name=>document.querySelector(`input[name="${name}"]:checked`)?.value;
const setRv=(name,val)=>{const r=document.querySelector(`input[name="${name}"][value="${val}"]`);if(r)r.checked=true};
let _editIdx=null; // null = add mode, number = edit mode
let _translations={};

async function loadTranslations(){
  _translations=await api('/api/ui_translations');
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k=el.getAttribute('data-i18n');
    if(_translations[k]){
      if(el.tagName==='INPUT'&&el.type==='button') el.value=_translations[k];
      else el.textContent=_translations[k];
    }
  });
}

function initTableResizers() {
  document.querySelectorAll('.rule-table').forEach(table => {
    const ths = table.querySelectorAll('th');
    ths.forEach(th => {
      if (th.querySelector('.resizer')) return;
      const resizer = document.createElement('div');
      resizer.classList.add('resizer');
      th.appendChild(resizer);
      let startX, startWidth;
      resizer.addEventListener('mousedown', function(e) {
        startX = e.pageX;
        startWidth = th.offsetWidth;
        document.body.style.cursor = 'col-resize';
        const onMouseMove = (e) => {
          const newWidth = startWidth + (e.pageX - startX);
          th.style.width = Math.max(newWidth, 30) + 'px';
        };
        const onMouseUp = () => {
          document.body.style.cursor = 'default';
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    });
  });
}

function toast(msg,err){const t=$('toast');t.textContent=msg;t.className='toast'+(err?' err':'')+' show';setTimeout(()=>t.className='toast',3000)}
function dlog(msg){const l=$('d-log');l.textContent+='\n['+new Date().toLocaleTimeString()+'] '+msg;l.scrollTop=l.scrollHeight}
function slog(msg){const l=$('s-log');if(l){l.textContent+='\n['+new Date().toLocaleTimeString()+'] '+msg;l.scrollTop=l.scrollHeight}}
function alog(msg){const l=$('a-log');l.textContent+='\n'+msg;l.scrollTop=l.scrollHeight}

/* ‚îÄ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function switchTab(id){
  document.querySelectorAll('.tab').forEach((t,i)=>{t.classList.toggle('active',t.textContent.trim().toLowerCase().startsWith(id.slice(0,4)))});
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  $('p-'+id).classList.add('active');
  if(id==='rules') loadRules();
  if(id==='settings') loadSettings();
  if(id==='dashboard') loadDashboard();
}

/* ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadDashboard(){
  const d=await api('/api/status');
  $('hdr-meta').textContent=`v${d.version} | ${d.api_url}`;
  $('d-rules').textContent=d.rules_count;
  $('d-health').textContent=d.health_check?'ON':'OFF';
  $('d-lang').textContent=(d.language||'en').toUpperCase();
  if(d.theme) document.documentElement.setAttribute('data-theme', d.theme);

  if (d.cooldowns && d.cooldowns.length > 0) {
    const activeCds = d.cooldowns.filter(c => c.remaining_mins > 0).length;
    if (activeCds > 0) {
      const title = _translations['gui_cooldown_title'] || 'Rules in Cooldown';
      $('cd-field').style.display='block';
      $('cd-list').innerHTML = `<div class="card" style="border-color:var(--warn);"><div class="label" style="color:var(--warn);"><span style="margin-right:4px;">‚è≥</span>${title}</div><div class="value" style="color:var(--warn);">${activeCds}</div></div>`;
    } else {
      $('cd-field').style.display='none';
      $('cd-list').innerHTML='';
    }
  } else {
    $('cd-field').style.display='none';
    $('cd-list').innerHTML='';
  }

  await loadTranslations();
  await loadDashboardQueries();
}
async function testConn(){
  slog('Testing PCE connection...');
  const r=await post('/api/actions/test-connection',{});
  if(r.ok){$('d-api').textContent='Connected';$('d-api').className='value ok';slog('‚úÖ Connected (HTTP '+r.status+')')}
  else{$('d-api').textContent='Error';$('d-api').className='value err';slog('‚ùå '+( r.error||r.body))}
}

let _dashboardQueries = [];

async function loadDashboardQueries() {
  const rt = await window.fetch('/api/dashboard/queries');
  _dashboardQueries = await rt.json() || [];
  renderDashboardQueries();
}

const escapeHtml = (unsafe) => {
    return (unsafe || '').toString()
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
};

function renderDashboardQueries() {
  const container = $('d-queries-container');
  let html = '';
  if(_dashboardQueries.length === 0){
      html = `<div style="text-align:center;padding:20px;color:var(--dim);font-size:0.9rem;">${_translations['gui_top10_empty']||'No data.'}</div>`;
  } else {
      _dashboardQueries.forEach((q, i) => {
          let badgeColor = "var(--primary)";
          if(q.pd === 2) badgeColor = "var(--danger)";
          else if(q.pd === 1) badgeColor = "var(--warn)";
          else if(q.pd === 0) badgeColor = "var(--success)";
          
          let rankLabel = q.rank_by === 'bandwidth' ? 'Max Bandwidth (Mbps)' : (q.rank_by === 'volume' ? 'Total Volume (MB)' : 'Connection Count');
          html += `
          <div style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;">
             <div style="display:flex;align-items:center;min-height:30px;">
                <strong style="margin-right:12px;font-size:0.95rem;color:var(--accent2);">${escapeHtml(q.name)}</strong>
                <span style="font-size:10px;background:${badgeColor};color:#fff;padding:2px 6px;border-radius:4px;margin-right:8px;">PD: ${q.pd===3?'All':(q.pd===2?'Blocked':(q.pd===1?'Potential':'Allowed'))}</span>
                <span style="font-size:10px;background:var(--dim);color:#fff;padding:2px 6px;border-radius:4px;margin-right:8px;">${rankLabel}</span>
                <span style="flex:1"></span>
                <span id="d-qstate-${i}" style="color:var(--dim);font-size:0.8rem;margin-right:12px;"></span>
                <button class="btn btn-sm" style="background:var(--bg);border:1px solid var(--border);margin-right:6px;" onclick="openQueryModal(${i})">‚úèÔ∏è</button>
                <button class="btn btn-primary btn-sm" onclick="runTop10Query(${i})" data-i18n="gui_run_btn">Run</button>
             </div>
             
             <table class="rule-table" style="margin-top:10px;border-top:1px solid var(--border);font-size:0.8rem;">
              <thead><tr>
                <th style="width:25px">#</th>
                <th style="width:100px" data-i18n="gui_value">Value</th>
                <th style="width:110px">First/Last Seen</th>
                <th style="width:40px;text-align:center;">Dir</th>
                <th>Source</th>
                <th>Destination</th>
                <th style="width:70px">Service</th>
                <th style="width:70px" data-i18n="gui_policy_dec">Decision</th>
              </tr></thead>
              <tbody id="d-qbody-${i}">
                <tr><td colspan="8" style="text-align:center;color:var(--dim);padding:20px;">${_translations['gui_top10_empty']||'No data. Click Run to query.'}</td></tr>
              </tbody>
             </table>
          </div>`;
      });
  }
  container.innerHTML = html;
  initTableResizers();
  
  if (typeof applyLang === "function") applyLang();
  else loadTranslations().catch(console.error);
}

function openQueryModal(idx = -1) {
  $('dq-idx').value = idx;
  if (idx < 0) {
      $('mq-title').textContent = _translations['gui_add_query_widget'] || 'Add Query Widget';
      $('dq-name').value = '';
      $('dq-rank').value = 'count';
      document.querySelector('input[name="dq-pd"][value="3"]').checked = true;
      $('dq-port').value = ''; $('dq-proto').value = '';
      $('dq-src').value = ''; $('dq-dst').value = '';
      $('dq-expt').value = ''; $('dq-exsrc').value = ''; $('dq-exdst').value = '';
  } else {
      $('mq-title').textContent = 'Edit Query Widget';
      const q = _dashboardQueries[idx];
      $('dq-name').value = q.name || '';
      $('dq-rank').value = q.rank_by || 'count';
      const pdRad = document.querySelector(`input[name="dq-pd"][value="${q.pd}"]`);
      if(pdRad) pdRad.checked = true;
      $('dq-port').value = q.port || ''; 
      $('dq-proto').value = q.proto || '';
      $('dq-src').value = (q.src_label||'')+(q.src_ip_in? (q.src_label? ', ':'')+q.src_ip_in : '');
      $('dq-dst').value = (q.dst_label||'')+(q.dst_ip_in? (q.dst_label? ', ':'')+q.dst_ip_in : '');
      $('dq-expt').value = q.ex_port || '';
      $('dq-exsrc').value = (q.ex_src_label||'')+(q.ex_src_ip? (q.ex_src_label? ', ':'')+q.ex_src_ip : '');
      $('dq-exdst').value = (q.ex_dst_label||'')+(q.ex_dst_ip? (q.ex_dst_label? ', ':'')+q.ex_dst_ip : '');
  }
  let btn = document.querySelector('#m-query .modal-actions');
  let isEdit = idx >= 0;
  if(isEdit && !document.getElementById('m-query-del')){
    let delBtn = document.createElement('button');
    delBtn.id = 'm-query-del';
    delBtn.className = 'btn btn-danger';
    delBtn.innerText = _translations['gui_delete'] || 'Delete';
    delBtn.style.marginRight = 'auto';
    delBtn.onclick = () => deleteTop10Query(idx);
    btn.insertBefore(delBtn, btn.firstChild);
  } else if (!isEdit && document.getElementById('m-query-del')) {
    document.getElementById('m-query-del').remove();
  }
  
  const m = $('m-query');
  if (m) m.classList.add('show');
}

async function saveDashboardQuery() {
    const idx = parseInt($('dq-idx').value);
    const pdMatch = document.querySelector('input[name="dq-pd"]:checked');
    const d = {
        idx: idx >= 0 ? idx : null,
        name: $('dq-name').value,
        rank_by: $('dq-rank').value,
        pd: pdMatch ? parseInt(pdMatch.value) : 3,
        port: parseInt($('dq-port').value) || null,
        proto: parseInt($('dq-proto').value) || null,
        src: $('dq-src').value, dst: $('dq-dst').value,
        ex_port: parseInt($('dq-expt').value) || null,
        ex_src: $('dq-exsrc').value, ex_dst: $('dq-exdst').value
    };
    
    // Quick API helper if not strictly using fetch directly
    const r = await fetch('/api/dashboard/queries', {
      method: 'POST', body: JSON.stringify(d), headers: {'Content-Type': 'application/json'}
    }).then(res => res.json());
    
    if(r.ok) { 
        const m = $('m-query');
        if (m) m.classList.remove('show');
        await loadDashboardQueries(); 
    }
    else alert("Error: " + r.error);
}

async function deleteTop10Query(idx) {
    if(!confirm("Delete this widget?")) return;
    const r = await fetch('/api/dashboard/queries/'+idx, {method:'DELETE'}).then(res => res.json());
    if(r.ok) { 
        const m = $('m-query');
        if (m) m.classList.remove('show');
        await loadDashboardQueries(); 
    }
    else alert("Delete failed");
}

async function runAllQueries() {
    for(let i=0; i<_dashboardQueries.length; i++) {
        await runTop10Query(i);
    }
}

async function runTop10Query(idx){
  const q = _dashboardQueries[idx];
  const ms=$(`d-qstate-${idx}`), bd=$(`d-qbody-${idx}`);
  if(!ms || !bd) return;
  
  const payload = { ...q, mins: parseInt($('d-global-min').value)||30 };
  
  ms.textContent = _translations['gui_top10_querying']||'Querying...'; 
  bd.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--dim);padding:20px;">${_translations['gui_top10_loading']||'Loading...'}</td></tr>`;
  
  try {
    const r = await fetch('/api/dashboard/top10', {
      method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'application/json'}
    }).then(res => res.json());
    if(!r.ok) throw new Error(r.error||'Unknown error');
    
    if(r.data && r.data.length){
      let html='';
      r.data.forEach((m,i)=>{
        const pBadge = m.pd===2 ? `<span style="background:var(--danger);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">Blocked</span>` :
                       m.pd===1 ? `<span style="background:var(--warn);color:#000;padding:2px 6px;border-radius:4px;font-size:10px;">Potential</span>` :
                       m.pd===0 ? `<span style="background:var(--success);color:#fff;padding:2px 6px;border-radius:4px;font-size:10px;">Allowed</span>` : m.pd;
                       
        const formatLabel = (labels) => {
            if(!labels || !labels.length) return '';
            return labels.map(l => `<span style="background:#e1ecf4;color:#2c5e77;padding:1px 4px;border-radius:4px;font-size:9px;margin-right:2px;display:inline-block;white-space:nowrap;margin-top:2px;">${escapeHtml(l.key)}:${escapeHtml(l.value)}</span>`).join('');
        };
        const sLabels = formatLabel(m.s_labels);
        const dLabels = formatLabel(m.d_labels);
                       
        html+=`
          <tr>
            <td>${i+1}</td>
            <td style="font-weight:bold;color:#6f42c1;">${m.val_fmt}</td>
            <td style="font-size:10px;white-space:nowrap;">${m.first_seen}<br>${m.last_seen}</td>
            <td style="text-align:center;">${m.dir}</td>
            <td><strong style="font-size:11px;">${escapeHtml(m.s_name)}</strong><br><small style="color:var(--dim);">${escapeHtml(m.s_ip)}</small><br>${sLabels}</td>
            <td><strong style="font-size:11px;">${escapeHtml(m.d_name)}</strong><br><small style="color:var(--dim);">${escapeHtml(m.d_ip)}</small><br>${dLabels}</td>
            <td>${escapeHtml(m.svc)}</td>
            <td>${pBadge}</td>
          </tr>`;
      });
      bd.innerHTML=html;
      ms.textContent = (_translations['gui_top10_found']||'Found {count} records. (Top 10)').replace('{count}', r.total);
    } else {
      bd.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--dim);padding:20px;">${_translations['gui_top10_no_records']||'No records found.'}</td></tr>`;
      ms.textContent = _translations['gui_done']||'Done.';
    }
    initTableResizers();
  } catch(e) {
    ms.textContent = 'Error: '+e.message;
    bd.innerHTML = `<tr><td colspan="8" style="text-align:center;color:var(--danger);padding:20px;">${_translations['gui_top10_error']||'Error querying data.'}</td></tr>`;
  }
}

/* ‚îÄ‚îÄ‚îÄ Rules ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let _catalog={};
async function loadRules(){
  const rules=await api('/api/rules');
  $('r-badge').textContent=rules.length;
  const pdm={2:'Blocked',1:'Potential',0:'Allowed','-1':'All'};
  
  const cdTitle = _translations['gui_cooldown_active'] || 'Cooldown';
  const readyTitle = _translations['gui_cooldown_ready'] || 'Ready';
  const remTempl = _translations['gui_cooldown_remaining'] || '{mins}m remaining';
  
  let html='';
  rules.forEach(r=>{
    const typ=r.type.charAt(0).toUpperCase()+r.type.slice(1);
    const unit={volume:' MB',bandwidth:' Mbps',traffic:' conns'}[r.type]||'';
    const cond='> '+r.threshold_count+unit+' (Win:'+r.threshold_window+'m CD:'+(r.cooldown_minutes||r.threshold_window)+'m)';
    
    let statusHtml = '';
    if (r.cooldown_remaining > 0) {
      const rem = remTempl.replace('{mins}', r.cooldown_remaining);
      statusHtml = `<span style="background:var(--warn);color:#1a2c32;padding:2px 6px;border-radius:4px;font-size:0.75rem;font-weight:600;">‚è≥ ${cdTitle} (${rem})</span>`;
    } else {
      statusHtml = `<span style="background:var(--success);color:#fff;padding:2px 6px;border-radius:4px;font-size:0.75rem;font-weight:600;">‚úÖ ${readyTitle}</span>`;
    }
    
    let f=[];
    if(r.type==='event') f.push('Event: '+r.filter_value);
    if(r.pd!==undefined&&r.pd!==null) f.push('PD:'+( pdm[r.pd]||r.pd));
    if(r.port) f.push('Port:'+r.port);
    if(r.src_label) f.push('Src:'+r.src_label);if(r.dst_label) f.push('Dst:'+r.dst_label);
    if(r.src_ip_in) f.push('SrcIP:'+r.src_ip_in);if(r.dst_ip_in) f.push('DstIP:'+r.dst_ip_in);
    html+=`<tr><td><input type="checkbox" class="r-chk" data-idx="${r.index}"></td><td title="${typ}">${typ}</td><td title="${escapeHtml(r.name)}">${escapeHtml(r.name)}</td><td>${statusHtml}</td><td title="${cond}">${cond}</td><td title="${escapeHtml(f.join(' | '))}">${escapeHtml(f.join(' | '))||'‚Äî'}</td><td><button class="btn btn-primary btn-sm" onclick="editRule(${r.index},'${r.type}')">‚úèÔ∏è</button></td></tr>`;
  });
  $('r-body').innerHTML=html||'<tr><td colspan="7" style="color:var(--dim);text-align:center;padding:24px">No rules. Add one above.</td></tr>';
  initTableResizers();
}
function toggleAll(el){document.querySelectorAll('.r-chk').forEach(c=>c.checked=el.checked)}
async function deleteSelected(){
  const ids=[...document.querySelectorAll('.r-chk:checked')].map(c=>parseInt(c.dataset.idx)).sort((a,b)=>b-a);
  if(!ids.length){toast('Select rules first','err');return}
  if(!confirm('Delete '+ids.length+' rule(s)?'))return;
  for(const i of ids) await del('/api/rules/'+i);
  toast('Deleted');loadRules();loadDashboard();
}
function openModal(id,isEdit){
  _editIdx=isEdit??null;$(id).classList.add('show');if(id==='m-event'&&!Object.keys(_catalog).length)loadCatalog();
  // Update modal title
  let target;
  if(id==='m-event') target=$('me-title');
  else if(id==='m-traffic') target=$('mt-title');
  else if(id==='m-bw') target=$('mb-title');
  if(target){
    const baseKey = id==='m-event'?'gui_add_event_rule':id==='m-traffic'?'gui_add_traffic_rule':'gui_add_bw_rule';
    const editKey = id==='m-event'?'gui_edit_event_rule':id==='m-traffic'?'gui_edit_traffic_rule':'gui_edit_bw_rule';
    const key = _editIdx!==null ? editKey : baseKey;
    target.setAttribute('data-i18n', key);
    if(_translations[key]) target.textContent=_translations[key];
  }
}
function closeModal(id){$(id).classList.remove('show');_editIdx=null}
async function loadCatalog(){
  _catalog=await api('/api/event-catalog');
  const sel=$('ev-cat');sel.innerHTML='<option value="">Select...</option>';
  Object.keys(_catalog).forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o)});
}
function populateEvents(){
  const cat=$('ev-cat').value;const sel=$('ev-type');sel.innerHTML='';
  if(!cat||!_catalog[cat]){sel.innerHTML='<option>Select category first</option>';return}
  Object.entries(_catalog[cat]).forEach(([k,v])=>{const o=document.createElement('option');o.value=k;o.textContent=k+' ('+v+')';sel.appendChild(o)});
}

/* ‚îÄ‚îÄ‚îÄ Edit Rule ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function editRule(idx,type){
  try {
    const r=await api('/api/rules/'+idx);
    if(!r || r.error){toast('Rule not found','err');return}
    if(type==='event'){
      await loadCatalog();
      // Find and select category
      for(const[cat,evts] of Object.entries(_catalog)){
        if(r.filter_value in evts){$('ev-cat').value=cat;populateEvents();$('ev-type').value=r.filter_value;break}
      }
      setRv('ev-tt',r.threshold_type||'immediate');
      $('ev-cnt').value=r.threshold_count||5;
      $('ev-win').value=r.threshold_window||10;
      $('ev-cd').value=r.cooldown_minutes||10;
      openModal('m-event',idx);
    } else if(type==='traffic'){
      $('tr-name').value=r.name||'';
      setRv('tr-pd',String(r.pd??2));
      $('tr-port').value=r.port||'';
      $('tr-proto').value=r.proto?String(r.proto):'';
      $('tr-src').value=r.src_label||r.src_ip_in||'';
      $('tr-dst').value=r.dst_label||r.dst_ip_in||'';
      $('tr-expt').value=r.ex_port||'';
      $('tr-exsrc').value=r.ex_src_label||r.ex_src_ip||'';
      $('tr-exdst').value=r.ex_dst_label||r.ex_dst_ip||'';
      $('tr-cnt').value=r.threshold_count||10;
      $('tr-win').value=r.threshold_window||10;
      $('tr-cd').value=r.cooldown_minutes||10;
      openModal('m-traffic',idx);
    } else {
      $('bw-name').value=r.name||'';
      setRv('bw-mt',r.type||'bandwidth');
      setRv('bw-pd',String(r.pd??-1));
      $('bw-port').value=r.port||'';
      $('bw-src').value=r.src_label||r.src_ip_in||'';
      $('bw-dst').value=r.dst_label||r.dst_ip_in||'';
      $('bw-expt').value=r.ex_port||'';
      $('bw-exsrc').value=r.ex_src_label||r.ex_src_ip||'';
      $('bw-exdst').value=r.ex_dst_label||r.ex_dst_ip||'';
      $('bw-val').value=r.threshold_count||100;
      $('bw-win').value=r.threshold_window||10;
      $('bw-cd').value=r.cooldown_minutes||30;
      openModal('m-bw',idx);
    }
  } catch(e) {
    console.error(e);
    alert('UI Error: ' + e.message);
  }
}

async function saveEvent(){
  const cat=$('ev-cat').value,ev=$('ev-type').value;
  if(!cat||!ev){toast('Select category and event','err');return}
  const name=(_catalog[cat]||{})[ev]||ev;
  const data={name,filter_value:ev,threshold_type:rv('ev-tt'),threshold_count:$('ev-cnt').value,threshold_window:$('ev-win').value,cooldown_minutes:$('ev-cd').value};
  if(_editIdx!==null) await put('/api/rules/'+_editIdx,data); else await post('/api/rules/event',data);
  closeModal('m-event');toast('Event rule saved');loadRules();loadDashboard();
}
async function saveTraffic(){
  const name=$('tr-name').value.trim();if(!name){toast('Name required','err');return}
  const data={name,pd:rv('tr-pd'),port:$('tr-port').value,proto:$('tr-proto').value,src:$('tr-src').value,dst:$('tr-dst').value,ex_port:$('tr-expt').value,ex_src:$('tr-exsrc').value,ex_dst:$('tr-exdst').value,threshold_count:$('tr-cnt').value,threshold_window:$('tr-win').value,cooldown_minutes:$('tr-cd').value};
  if(_editIdx!==null) await put('/api/rules/'+_editIdx,data); else await post('/api/rules/traffic',data);
  closeModal('m-traffic');toast('Traffic rule saved');loadRules();loadDashboard();
}
async function saveBW(){
  const name=$('bw-name').value.trim();if(!name){toast('Name required','err');return}
  const data={
    name,rule_type:rv('bw-mt'),pd:rv('bw-pd'),
    port:$('bw-port').value,src:$('bw-src').value,dst:$('bw-dst').value,
    ex_port:$('bw-expt').value,ex_src:$('bw-exsrc').value,ex_dst:$('bw-exdst').value,
    threshold_count:$('bw-val').value,threshold_window:$('bw-win').value,cooldown_minutes:$('bw-cd').value
  };
  if(_editIdx!==null) await put('/api/rules/'+_editIdx,{...data,type:data.rule_type}); else await post('/api/rules/bandwidth',data);
  closeModal('m-bw');toast('Rule saved');loadRules();loadDashboard();
}

function confirmBestPractices(){
  if(!confirm('‚ö†Ô∏è WARNING: This will DELETE all existing rules and replace them with best practice defaults.\n\nAre you sure you want to continue?')) return;
  if(!confirm('This action cannot be undone. Confirm once more to proceed.')) return;
  runAction('best-practices');
}

/* ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let _settings={};
async function loadSettings(){
  _settings=await api('/api/settings');
  const s=_settings,a=s.api||{},e=s.email||{},sm=s.smtp||{},al=s.alerts||{},st=s.settings||{};
  const active=al.active||[];
  $('s-form').innerHTML=`
  <fieldset><legend data-i18n="gui_api_conn">API Connection</legend>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_url">URL</label><input id="s-url" value="${a.url||''}"></div><div class="form-group"><label data-i18n="gui_org_id">Org ID</label><input id="s-org" value="${a.org_id||''}"></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_api_key">API Key</label><input id="s-key" value="${a.key||''}"></div><div class="form-group"><label data-i18n="gui_api_secret">API Secret</label><input id="s-sec" type="password" value="${a.secret||''}"></div></div>
    <div class="chk"><label><input type="checkbox" id="s-ssl" ${a.verify_ssl?'checked':''}> <span data-i18n="gui_verify_ssl">Verify SSL</span></label></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_email_smtp">Email & SMTP</legend>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_sender">Sender</label><input id="s-sender" value="${e.sender||''}"></div><div class="form-group"><label data-i18n="gui_recipients">Recipients (comma)</label><input id="s-rcpt" value="${(e.recipients||[]).join(', ')}"></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_smtp_host">SMTP Host</label><input id="s-smhost" value="${sm.host||''}"></div><div class="form-group"><label data-i18n="gui_port">Port</label><input id="s-smport" value="${sm.port||25}"></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_user">User</label><input id="s-smuser" value="${sm.user||''}"></div><div class="form-group"><label data-i18n="gui_password">Password</label><input id="s-smpass" type="password" value="${sm.password||''}"></div></div>
    <div style="display:flex;gap:20px"><div class="chk"><label><input type="checkbox" id="s-tls" ${sm.enable_tls?'checked':''}> STARTTLS</label></div><div class="chk"><label><input type="checkbox" id="s-auth" ${sm.enable_auth?'checked':''}> Auth</label></div></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_alert_channels">Alert Channels</legend>
    <div style="display:flex;gap:20px;margin-bottom:12px"><div class="chk"><label><input type="checkbox" id="s-amail" ${active.includes('mail')?'checked':''}> üìß <span data-i18n="gui_mail">Mail</span></label></div><div class="chk"><label><input type="checkbox" id="s-aline" ${active.includes('line')?'checked':''}> üì± <span data-i18n="gui_line">LINE</span></label></div><div class="chk"><label><input type="checkbox" id="s-awh" ${active.includes('webhook')?'checked':''}> üîó <span data-i18n="gui_webhook">Webhook</span></label></div></div>
    <div class="form-row"><div class="form-group"><label data-i18n="gui_line_token">LINE Token</label><input id="s-ltok" value="${al.line_channel_access_token||''}"></div><div class="form-group"><label data-i18n="gui_line_target_id">LINE Target ID</label><input id="s-ltgt" value="${al.line_target_id||''}"></div></div>
    <div class="form-group"><label data-i18n="gui_webhook_url">Webhook URL</label><input id="s-whurl" value="${al.webhook_url||''}"></div>
  </fieldset>
  <fieldset><legend data-i18n="gui_lang_settings">Display & General</legend>
    <div class="chk" style="margin-bottom:12px"><label><input type="checkbox" id="s-hc" ${st.enable_health_check!==false?'checked':''}> <span data-i18n="gui_enable_hc">Enable PCE Health Check</span></label></div>
    <div class="form-row">
      <div class="form-group">
        <label data-i18n="gui_language">Language</label>
        <div class="radio-group">
          <label><input type="radio" name="s-lang" value="en" ${st.language!=='zh_TW'?'checked':''}> <span data-i18n="gui_lang_en">English</span></label>
          <label><input type="radio" name="s-lang" value="zh_TW" ${st.language==='zh_TW'?'checked':''}> <span data-i18n="gui_lang_zh">ÁπÅÈ´î‰∏≠Êñá</span></label>
        </div>
      </div>
      <div class="form-group">
        <label>Theme</label>
        <div class="radio-group">
          <label><input type="radio" name="s-theme" value="dark" ${st.theme!=='light'?'checked':''}> <span data-i18n="gui_theme_dark">Dark Theme</span></label>
          <label><input type="radio" name="s-theme" value="light" ${st.theme==='light'?'checked':''}> <span data-i18n="gui_theme_light">Light Theme</span></label>
        </div>
      </div>
    </div>
  </fieldset>`;
  await loadTranslations();
}
async function saveSettings(){
  const active=[];if($('s-amail').checked)active.push('mail');if($('s-aline').checked)active.push('line');if($('s-awh').checked)active.push('webhook');
  const theme = rv('s-theme');
  document.documentElement.setAttribute('data-theme', theme);
  await post('/api/settings',{
    api:{url:$('s-url').value,org_id:$('s-org').value,key:$('s-key').value,secret:$('s-sec').value,verify_ssl:$('s-ssl').checked},
    email:{sender:$('s-sender').value,recipients:$('s-rcpt').value.split(',').map(s=>s.trim()).filter(Boolean)},
    smtp:{host:$('s-smhost').value,port:parseInt($('s-smport').value)||25,user:$('s-smuser').value,password:$('s-smpass').value,enable_tls:$('s-tls').checked,enable_auth:$('s-auth').checked},
    alerts:{active,line_channel_access_token:$('s-ltok').value,line_target_id:$('s-ltgt').value,webhook_url:$('s-whurl').value},
    settings:{language:rv('s-lang'), theme: theme, enable_health_check:$('s-hc').checked}
  });
  toast('Settings saved');
}

/* ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function runAction(name){
  $('a-log').textContent='['+new Date().toLocaleTimeString()+'] Running '+name+'...';
  const r=await post('/api/actions/'+name,{});
  alog(r.output||'Done.');
  if(name==='best-practices'){loadRules();loadDashboard()}
  toast('‚úÖ '+name+' completed');
}
async function runDebug(){
  $('a-log').textContent='['+new Date().toLocaleTimeString()+'] Running debug mode...';
  const r=await post('/api/actions/debug',{mins:$('a-debug-mins').value,pd_sel:$('a-debug-pd').value});
  alog(r.output||'Done.');
  toast('‚úÖ Debug completed');
}

/* ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function stopGui(){
  if(!confirm('Stop the Web GUI server? The browser page will close.')) return;
  try{ await post('/api/shutdown',{}); } catch(e){}
  document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;gap:12px"><h1 style="color:var(--accent2)">Web GUI Stopped</h1><p style="color:var(--dim)">You may close this tab. Restart from CLI or use --gui.</p></div>';
}
loadDashboard();
testConn();
</script>
</body>
</html>